<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador Diario de Clientes</title>
  <style>
    :root{
      --bg:#0b0c0e; --card:#121419; --ink:#eaeef3; --muted:#aab3c2; --accent:#5ee6a5; --line:#232731;
      --danger:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    h1{font-size:clamp(1.2rem,2.8vw,1.8rem);margin:0}
    .wrap{max-width:1050px;margin:auto;padding:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="date"],input[type="text"],input[type="search"],textarea,button,.pill,select{border:1px solid var(--line);background:#0e1015;color:#eaeef3;padding:12px 14px;border-radius:12px}
    input[type="text"],input[type="search"],textarea{width:100%}
    input.lg{font-size:1.05rem;padding:14px 16px}
    textarea{min-height:120px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#19c37d,#0aa56a);border:none;color:#04130b;font-weight:700}
    button.ghost{background:transparent}
    button.danger{background:#2a1416;border:1px solid #5a2126;color:#ffb3b8}
    button.warn{background:#2a2312;border:1px solid #57481a;color:#ffe8a3}
    .toolbar{gap:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-top:14px}
    .item{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:12px}
    .item input[type="checkbox"]{transform:scale(1.25);margin-top:3px}
    .muted{color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .pill{user-select:none}
    .pill.active{outline:2px solid var(--accent);}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hidden{display:none}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .right{justify-content:flex-end}
    .checkall{display:flex;align-items:center;gap:8px}
    .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
    .hint{font-size:13px;color:var(--muted)}
    .searchWrap{display:flex;gap:8px;align-items:center;min-width:320px}
    .searchWrap button{padding:10px 12px}
    ol.route{margin:0;padding-left:22px}
    ol.route li{margin:6px 0}
    .visit{display:flex;align-items:center;gap:10px}
    .visit.done span{opacity:.7;text-decoration:line-through}
    .visit .tick{transform:scale(1.2)}
    @media (max-width:860px){.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="margin-bottom:16px">
      <h1>Planificador diario de clientes</h1>
      <span class="badge" id="version">v1.4</span>
      <div class="grow"></div>
      <button class="ghost" id="toggleTheme" title="Cambiar tema">üåì</button>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="pill active" data-tab="plan">üóìÔ∏è Plan diario</div>
        <div class="pill" data-tab="ruta">üß≠ Ruta del d√≠a</div>
        <div class="pill" data-tab="rutas">üì¶ Rutas predefinidas</div>
        <div class="pill" data-tab="clientes">üë• Clientes</div>
        <div class="pill" data-tab="ayuda">‚ùì Ayuda</div>
      </div>

      <!-- PLAN DIARIO -->
      <section id="tab-plan">
        <div class="row toolbar">
          <label>
            <span class="muted">Fecha</span><br>
            <input type="date" id="fecha" />
          </label>
          <button id="hoy">Hoy</button>

          <div class="grow"></div>

          <div class="searchWrap grow" title="Buscar y limpiar con la X">
            <div class="grow">
              <span class="muted">Buscar cliente</span><br>
              <input type="search" class="lg" id="buscador" placeholder="Escribe para filtrar‚Ä¶" />
            </div>
            <button id="clearSearch" title="Borrar b√∫squeda">‚úï</button>
          </div>

          <label class="checkall">
            <input type="checkbox" id="toggleAll"> Seleccionar todos
          </label>

          <select id="selectRuta">
            <option value="">Rutas predefinidas‚Ä¶</option>
            <option value="R-1">R-1</option>
            <option value="R-2">R-2</option>
            <option value="R-3">R-3</option>
            <option value="R-4">R-4</option>
            <option value="R-5">R-5</option>
          </select>
          <button id="aplicarRuta">Aplicar</button>

          <button class="primary" id="guardar">Guardar d√≠a</button>
          <button class="warn" id="vaciar">Vaciar d√≠a</button>
          <button id="imprimir">Imprimir</button>
          <button id="exportar">Exportar</button>
          <button id="importarBtn">Importar</button>
          <input type="file" id="importar" accept="application/json" class="hidden" />
        </div>

        <div class="foot"><span class="muted">Clientes visibles: <span id="count"></span></span><span class="muted">Los datos se guardan en este navegador.</span></div>
        <div id="lista" class="grid" aria-live="polite"></div>
      </section>

      <!-- RUTA DEL D√çA -->
      <section id="tab-ruta" class="hidden">
        <div class="row toolbar">
          <label>
            <span class="muted">Fecha</span><br>
            <input type="date" id="fechaRuta" />
          </label>
          <button id="hoyRuta">Hoy</button>
          <div class="grow"></div>
          <button id="imprimirRuta">Imprimir ruta</button>
        </div>
        <p class="hint">Marca cada visita como <em>hecha</em>. Se guarda por fecha y cliente.</p>
        <ol class="route" id="rutaLista"></ol>
      </section>

      <!-- RUTAS PREDEFINIDAS -->
      <section id="tab-rutas" class="hidden">
        <h3>Rutas predefinidas (R-1 a R-5)</h3>
        <p class="hint">Edita su contenido y apl√≠calas a cualquier d√≠a. Puedes tambi√©n guardar la selecci√≥n actual en una ruta. (Las rutas con nombre R-1‚Ä¶R-5 siempre existir√°n).</p>

        <div id="rutasBox" class="grid"></div>
      </section>

      <!-- CLIENTES -->
      <section id="tab-clientes" class="hidden">
        <div class="split">
          <div>
            <h3>Listado actual</h3>
            <p class="hint">Este listado se guarda en el navegador. Puedes a√±adir, borrar o restablecer.</p>
            <div class="row">
              <input class="grow" type="text" id="nuevoCliente" placeholder="Nombre del nuevo cliente" />
              <button id="addCliente">A√±adir</button>
              <button class="danger" id="resetClientes" title="Restablecer a la lista original">Reset</button>
            </div>
            <div id="clientesList" class="grid" style="margin-top:10px"></div>
          </div>
          <div>
            <h3>Alta masiva</h3>
            <p class="hint">Pega uno por l√≠nea. Evitamos duplicados autom√°ticamente.</p>
            <textarea id="bulk"></textarea>
            <div class="row right">
              <button id="bulkAdd">A√±adir en bloque</button>
            </div>
          </div>
        </div>
      </section>

      <!-- AYUDA -->
      <section id="tab-ayuda" class="hidden">
        <h3>C√≥mo usarlo</h3>
        <ol>
          <li>Elige una <strong>fecha</strong> o pulsa <em>Hoy</em>.</li>
          <li>Marca los <strong>clientes</strong> que quieras visitar ese d√≠a.</li>
          <li>Pulsa <strong>Guardar d√≠a</strong>. ¬°Listo!</li>
          <li>Para usar una <strong>ruta predefinida</strong>, esc√≥gela en el desplegable y pulsa <em>Aplicar</em>.</li>
        </ol>
        <p class="hint">Exporta tus datos antes de cambiar de ordenador o borrar la cach√©.</p>
      </section>
    </div>

    <div class="foot">
      <span>Hecho con ‚òïÔ∏è para que organizes tus rutas sin l√≠os.</span>
      <span class="muted">Datos locales ‚Ä¢ Sin conexi√≥n ‚Ä¢ 100% tuyo</span>
    </div>
  </div>

  <script>
  // Aseguramos que el JS no peta por detalles de entorno (localStorage/fechas)
  (function(){
    const safeStorage = (function(){
      try{
        const t='__test__';
        localStorage.setItem(t,'1'); localStorage.removeItem(t);
        return localStorage;
      }catch(_){
        let mem = {};
        return {
          getItem:k=>mem[k]||null,
          setItem:(k,v)=>{mem[k]=String(v)},
          removeItem:(k)=>{delete mem[k]}
        };
      }
    })();

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function todayStr(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function getDateFromInput(sel){
      const el = $(sel);
      if(!el || !el.value){ el && (el.value=todayStr()); }
      const d = new Date(el ? el.value : todayStr());
      return isNaN(d) ? new Date(todayStr()) : d;
    }
    function dateKey(d){
      const dd = (d instanceof Date && !isNaN(d)) ? d : new Date(todayStr());
      const yyyy = dd.getFullYear();
      const mm = String(dd.getMonth()+1).padStart(2,'0');
      const day = String(dd.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${day}`;
    }

    // ========= Datos por defecto =========
    const DEFAULT_CLIENTES = [
      "RTE L'ESTONETA","RTE PIPA","CUATRECASAS","SET POINT","MARIMBA","EL PEDREGAL","LES CATIVAS","BAR RESTAURANTE POMA","A PROP TEU","TIENDA RONDA SANT ANTONI","O BURATO BAR","BAR CAFETERIA MARIANA","MANDONI PEDRALBES","TEATRO NACIONAL DE CATALUNYA","RESTAURANT CENT FOCS","HOTEL MESON CASTILLA","BAR RTE LEPANTO","CAFE ILUSIONA BY MUXIA","EL MOLI PAN Y CAFE SANTS","OMBU, RTE","DAMAIA, BAR","EXE RAMBLAS BOQUERIA","PLEASE PLATS","RESTAURANTE HONKAKU II","O CANTO RESTAURANTE","SARA TAPES","HOTEL SB GLOW","TOC HOSTAL GRAN VIA","HOTEL SB ICARIA BARCELONA","CAFETERIA DOMI","TIENDA JOAQUIM VALLS","GOIKO GRILL CARRER CAN SEGALAR","EL FOC DEN CANIGO","GOIKO GRILL GRAN VIA DE LES CORTS","LA FILOMENA BAR","GOIKO GRILL CARRER INDEPENDENCIA","GOIKO GRILL BRUC","GOIKO GRILL C.C. SOM MULTIESPAI","EUROSTARS ANGLI","BAR CA√ëAS","GOIKO GRILL PASSEIG SANT JOAN","GARBI","SETEMBRE","LA CASSOLETA","GOIKO GRILL CARRER D'ARIBAU","TIENDA TORRES I BAGES","ATICCO PASSEIG DE GR√ÄCIA CANTINA","EXE LAIETANA PALACE","TIENDA MERIDIANA II","EUROSTARS CRISTAL PALACE","RIAS DE GALICIA RTE","MIRADOR SANT JUST","IKONIK RAMBLAS","GOIKO MARAGALL","CASA DE TAPAS LA CA√ëOTA","GOIKO GRILL LAIETANA","ALTIMA HOSPITALET GRAN VIA","RINCON GALEGO","BAR EUROPA","RESTAURANTE SUKAPA","ANTOTXO","RTE ZHU ZHU","EXE PLAZA CATALUNYA 4","EUROSTARS MONUMENTAL","EUROSTARS MITRE","TIENDA SANT VICEN√á DELS HORTS","FORN VELL INDUSTRIA","FORN VELL CLARET","TIENDA VIA JULIA","VALDAURA","PIPA S CAFETERIA","RESTAURANTE LA GORMANDA","BAR BUC","TOSTA BAR","ADELITA RESTAURANTE","MOLI PAN Y CAFE ZONA FRANCA","LOKAL","BATEA","BAR LOS PINOS 2","TSUKIMI","LA PALMERA","EL MIRALL DELS ENCANTS","LOMO ALTO","HOTEL ORIENTE","HOTEL ARENAS","HOTEL TRES TORRES","ESCAIRON","LA RUTA GALLEGA","TIENDA CLOT","LA BRASA RESTAURANTE","RTE ANCARES","A DUES RODES","CAFETERIA RONDA SANT BOI","TIENDA LES CORTS","LA LLAR DEL MERCAT 2 SANT BOI","HOTEL SB WIN SANT FELIU","LOS 3 ARCOS BAR","RTE MAMETORA","BOEDO","O RINCON GALLEGO MERIDIANA","R.U. COSMOPOLITAN","FRANKFURT TOLIK","CIURIS","CAFETERIA LEROY MERLIN SANT BOI","BAR DE BO","ESCUELA JUDICIAL BCN","O MEU LAR","EL CARQUINYOLI","NON SOLO CREPS","GREENVITA NUMANCIA","K10 SUSHI SANT BOI","EL RACONET D'URGELL","TIENDA EL TALLER SANT BOI","CHALITO BCN.","HOTEL FRONTAIR CONGRESS","CLUB TIRO MONTJUIT","FRANKFURT SANTS","R.U. EMILIE DE VILLENUEVE","SOLUCIONS SOCIALS INSERCIO","ALTIMA SANT BOI","FUNDACIO ASPACE CATALUNYA","GREEN VITA GLORIES","ATICCO PASSEIG DE GR√ÄCIA OFICINA","70/30","ORDAL","PESSEBRE","BUFFS DE FARINA","TIENDA TALLER VALLDAURA","ARTESANO","HELADER√çA ADRI GELATIAMO"
    ];

    const DEFAULT_RUTAS = { 'R-1': [], 'R-2': [], 'R-3': [], 'R-4': [], 'R-5': [] };

    const LS_KEYS = {
      clientes: 'clientes',        // array de strings
      planes: 'planes',            // objeto: { 'YYYY-MM-DD': [clientes] }
      rutas: 'rutasPredef',        // objeto: { 'R-1': [clientes], ... }
      hechos: 'visitasHechas'      // objeto: { 'YYYY-MM-DD': { 'Cliente A': true, ... } }
    };

    function load(key, fallback){
      try{ const raw = safeStorage.getItem(key); return raw? JSON.parse(raw) : fallback; }catch(_){ return fallback; }
    }
    function save(key, val){ try{ safeStorage.setItem(key, JSON.stringify(val)); }catch(_){} }

    // Estado
    let CLIENTES = load(LS_KEYS.clientes, [...new Set(DEFAULT_CLIENTES)]);
    let PLANES   = load(LS_KEYS.planes, {});
    let RUTAS    = Object.assign({}, DEFAULT_RUTAS, load(LS_KEYS.rutas, {}));
    let HECHOS   = load(LS_KEYS.hechos, {});

    // Pesta√±as
    function setupTabs(){
      $$('.pill').forEach(p=>p.addEventListener('click',()=>{
        $$('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        const tab = p.dataset.tab;
        $('#tab-plan').classList.toggle('hidden', tab!=='plan');
        $('#tab-ruta').classList.toggle('hidden', tab!=='ruta');
        $('#tab-rutas').classList.toggle('hidden', tab!=='rutas');
        $('#tab-clientes').classList.toggle('hidden', tab!=='clientes');
        $('#tab-ayuda').classList.toggle('hidden', tab!=='ayuda');
        if(tab==='ruta'){ renderRutaDia(); }
        if(tab==='rutas'){ renderRutas(); }
      }));
    }

    // Render listado
    function renderLista(){
      const cont = $('#lista'); if(!cont) return;
      const filtro = ($('#buscador')?.value||'').trim().toLowerCase();
      const key = dateKey(getDateFromInput('#fecha'));
      const seleccionados = new Set(PLANES[key]||[]);
      const visibles = CLIENTES.filter(c=> c.toLowerCase().includes(filtro));
      cont.innerHTML = '';
      if(!visibles.length){
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = '<div class="muted">No hay clientes que coincidan con la b√∫squeda.</div>';
        cont.appendChild(div);
      }
      visibles.forEach(nombre=>{
        const id = 'c-'+nombre.replace(/[^a-z0-9]+/gi,'-');
        const div = document.createElement('label');
        div.className = 'item';
        div.innerHTML = `
          <input type="checkbox" id="${id}"> 
          <div>
            <div><strong>${nombre}</strong></div>
            <div class="muted">Pulsa para incluir en el plan del d√≠a.</div>
          </div>`;
        const chk = div.querySelector('input');
        chk.checked = seleccionados.has(nombre);
        chk.addEventListener('change',()=>{
          if(chk.checked){ seleccionados.add(nombre); } else { seleccionados.delete(nombre); }
          PLANES[key] = Array.from(seleccionados);
          save(LS_KEYS.planes, PLANES);
          updateToggleAll();
        });
        cont.appendChild(div);
      });
      $('#count').textContent = visibles.length + ' / ' + CLIENTES.length;
      updateToggleAll();
    }

    function updateToggleAll(){
      const key = dateKey(getDateFromInput('#fecha'));
      const seleccionados = new Set(PLANES[key]||[]);
      const filtro = ($('#buscador')?.value||'').trim().toLowerCase();
      const visibles = CLIENTES.filter(c=> c.toLowerCase().includes(filtro));
      const allSelected = visibles.length>0 && visibles.every(c=> seleccionados.has(c));
      const t = $('#toggleAll'); if(t) t.checked = allSelected;
    }

    // Eventos plan
    function setupPlanEvents(){
      $('#fecha') && $('#fecha').addEventListener('change', ()=>{ renderLista(); syncRutaFecha(); });
      $('#hoy') && $('#hoy').addEventListener('click', ()=>{ $('#fecha').value = todayStr(); renderLista(); syncRutaFecha(); });
      $('#buscador') && $('#buscador').addEventListener('input', renderLista);
      $('#clearSearch') && $('#clearSearch').addEventListener('click', ()=>{ $('#buscador').value=''; renderLista(); $('#buscador').focus(); });
      $('#toggleAll') && $('#toggleAll').addEventListener('change', (e)=>{
        const key = dateKey(getDateFromInput('#fecha'));
        const filtro = ($('#buscador')?.value||'').trim().toLowerCase();
        const visibles = CLIENTES.filter(c=> c.toLowerCase().includes(filtro));
        if(e.target.checked){
          const set = new Set(PLANES[key]||[]); visibles.forEach(v=> set.add(v)); PLANES[key] = Array.from(set);
        } else {
          const remain = new Set(PLANES[key]||[]); visibles.forEach(v=> remain.delete(v)); PLANES[key] = Array.from(remain);
        }
        save(LS_KEYS.planes, PLANES);
        renderLista();
      });
      $('#guardar') && $('#guardar').addEventListener('click', ()=> alert('¬°D√≠a guardado!'));
      $('#vaciar') && $('#vaciar').addEventListener('click', ()=>{
        if(confirm('¬øSeguro que quieres vaciar la selecci√≥n de este d√≠a?')){
          const key = dateKey(getDateFromInput('#fecha'));
          PLANES[key] = [];
          save(LS_KEYS.planes, PLANES);
          delete HECHOS[key];
          save(LS_KEYS.hechos, HECHOS);
          renderLista();
        }
      });
      $('#imprimir') && $('#imprimir').addEventListener('click', ()=> window.print());
      $('#exportar') && $('#exportar').addEventListener('click', ()=>{
        const data = { clientes: CLIENTES, planes: PLANES, rutas: RUTAS, hechos: HECHOS };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'planificador_clientes.json'; a.click(); URL.revokeObjectURL(a.href);
      });
      $('#importarBtn') && $('#importarBtn').addEventListener('click', ()=> $('#importar').click());
      $('#importar') && $('#importar').addEventListener('change', (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const data = JSON.parse(r.result);
            if(Array.isArray(data.clientes)){ CLIENTES = [...new Set(data.clientes)]; save(LS_KEYS.clientes, CLIENTES); }
            if(data.planes && typeof data.planes==='object'){ PLANES = data.planes; save(LS_KEYS.planes, PLANES); }
            if(data.rutas && typeof data.rutas==='object'){ RUTAS = Object.assign({}, DEFAULT_RUTAS, data.rutas); save(LS_KEYS.rutas, RUTAS); }
            if(data.hechos && typeof data.hechos==='object'){ HECHOS = data.hechos; save(LS_KEYS.hechos, HECHOS); }
            renderClientesAdmin(); renderLista(); renderRutas(); alert('Datos importados correctamente.');
          }catch(err){ alert('Archivo no v√°lido.'); }
        };
        r.readAsText(f);
        e.target.value = '';
      });
      $('#aplicarRuta') && $('#aplicarRuta').addEventListener('click', ()=>{
        const sel = $('#selectRuta')?.value; if(!sel) return alert('Elige una ruta predefinida.');
        const key = dateKey(getDateFromInput('#fecha'));
        PLANES[key] = [...new Set(RUTAS[sel]||[])].filter(c=> CLIENTES.includes(c));
        save(LS_KEYS.planes, PLANES);
        renderLista();
        alert('Ruta '+sel+' aplicada al d√≠a.');
      });
    }

    // Admin clientes
    function renderClientesAdmin(){
      const box = $('#clientesList'); if(!box) return;
      box.innerHTML='';
      CLIENTES.forEach((c,i)=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div class="grow"><strong>${c}</strong></div><button class="danger" title="Eliminar">‚úï</button>`;
        row.querySelector('button').addEventListener('click', ()=>{
          if(confirm('¬øEliminar "'+c+'" del listado?')){ CLIENTES.splice(i,1); save(LS_KEYS.clientes, CLIENTES); renderClientesAdmin(); renderLista(); }
        });
        box.appendChild(row);
      });
    }
    function setupClientes(){
      $('#addCliente') && $('#addCliente').addEventListener('click', ()=>{
        const v = ($('#nuevoCliente')?.value||'').trim(); if(!v) return;
        if(!CLIENTES.includes(v)) CLIENTES.push(v);
        CLIENTES = [...new Set(CLIENTES)].sort((a,b)=>a.localeCompare(b));
        save(LS_KEYS.clientes, CLIENTES);
        $('#nuevoCliente').value=''; renderClientesAdmin(); renderLista();
      });
      $('#bulkAdd') && $('#bulkAdd').addEventListener('click', ()=>{
        const lines = ($('#bulk')?.value||'').split(/
?
/).map(s=>s.trim()).filter(Boolean);
        if(!lines.length) return;
        CLIENTES = [...new Set([...CLIENTES, ...lines])].sort((a,b)=>a.localeCompare(b));
        save(LS_KEYS.clientes, CLIENTES);
        $('#bulk').value=''; renderClientesAdmin(); renderLista();
      });
      $('#resetClientes') && $('#resetClientes').addEventListener('click', ()=>{
        if(confirm('¬øRestablecer el listado a la versi√≥n original?')){ CLIENTES = [...new Set(DEFAULT_CLIENTES)]; save(LS_KEYS.clientes, CLIENTES); renderClientesAdmin(); renderLista(); }
      });
    }

    // Rutas predefinidas
    function renderRutas(){
      const box = $('#rutasBox'); if(!box) return;
      box.innerHTML='';
      ['R-1','R-2','R-3','R-4','R-5'].forEach(k=>{
        const arr = RUTAS[k]||[];
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `
          <div class="grow">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <strong>${k}</strong> <span class="muted">(${arr.length} clientes)</span>
            </div>
            <details style="margin-top:6px"><summary>Ver lista</summary>
              <ul style="margin:6px 0 0 18px; padding:0">${arr.map(c=>`<li>${c}</li>`).join('')||'<li class="muted">(vac√≠a)</li>'}</ul>
            </details>
            <details style="margin-top:6px"><summary>Editar</summary>
              <p class="hint">Pega uno por l√≠nea. Se eliminan duplicados y nombres vac√≠os.</p>
              <textarea data-edit="${k}">${arr.join('
')}</textarea>
              <div class="row right" style="margin-top:6px">
                <button data-save="${k}">Guardar cambios</button>
                <button class="danger" data-clear="${k}">Vaciar</button>
                <button class="warn" data-resetk="${k}">Reset (dejar vac√≠a)</button>
              </div>
            </details>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; min-width:180px">
            <button data-apply="${k}">Aplicar al d√≠a ‚ñ∂</button>
            <button data-store="${k}">Guardar selecci√≥n actual en ${k}</button>
          </div>`;
        box.appendChild(div);
      });
      box.querySelectorAll('[data-apply]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-apply');
        const key = dateKey(getDateFromInput('#fecha'));
        PLANES[key] = [...new Set(RUTAS[k]||[])].filter(c=> CLIENTES.includes(c));
        save(LS_KEYS.planes, PLANES);
        renderLista();
        alert('Ruta '+k+' aplicada al d√≠a.');
      }));
      box.querySelectorAll('[data-store]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-store');
        const key = dateKey(getDateFromInput('#fecha'));
        const lista = PLANES[key]||[];
        RUTAS[k] = lista.filter(c=> CLIENTES.includes(c));
        save(LS_KEYS.rutas, RUTAS);
        renderRutas();
        alert('Selecci√≥n actual guardada en '+k+'.');
      }));
      box.querySelectorAll('[data-save]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-save');
        const ta = box.querySelector(`textarea[data-edit="${k}"]`);
        const lines = (ta?.value||'').split(/
?
/).map(s=>s.trim()).filter(Boolean);
        RUTAS[k] = [...new Set(lines)].filter(c=> CLIENTES.includes(c));
        save(LS_KEYS.rutas, RUTAS);
        renderRutas();
        alert('Ruta '+k+' actualizada.');
      }));
      box.querySelectorAll('[data-clear]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-clear');
        if(confirm('¬øVaciar por completo la ruta '+k+'?')){ RUTAS[k] = []; save(LS_KEYS.rutas, RUTAS); renderRutas(); }
      }));
      box.querySelectorAll('[data-resetk]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-resetk');
        if(confirm('Esto deja la ruta '+k+' vac√≠a (predefinida existe, pero sin clientes). ¬øContinuar?')){ RUTAS[k] = []; save(LS_KEYS.rutas, RUTAS); renderRutas(); }
      }));
    }

    // Ruta del d√≠a
    function renderRutaDia(){
      const fechaRuta = getDateFromInput('#fechaRuta');
      $('#fechaRuta').value = dateKey(getDateFromInput('#fecha'));
      const key = dateKey(fechaRuta);
      const lista = PLANES[key]||[];
      const hechos = HECHOS[key] || {};
      const ol = $('#rutaLista'); if(!ol) return;
      ol.innerHTML = '';
      if(!lista.length){
        const li = document.createElement('li'); li.innerHTML = '<span class="muted">(No hay clientes seleccionados para este d√≠a)</span>'; ol.appendChild(li); return;
      }
      lista.forEach((c)=>{
        const li = document.createElement('li');
        const checked = !!hechos[c];
        li.innerHTML = `<label class="visit ${checked ? 'done' : ''}"><input class="tick" type="checkbox" ${checked ? 'checked' : ''}><span>${c}</span></label>`;
        const cb = li.querySelector('input');
        cb.addEventListener('change', ()=>{
          const k = dateKey(getDateFromInput('#fechaRuta'));
          HECHOS[k] = HECHOS[k] || {}; HECHOS[k][c] = cb.checked; save(LS_KEYS.hechos, HECHOS);
          li.querySelector('.visit').classList.toggle('done', cb.checked);
        });
        ol.appendChild(li);
      });
    }
    function syncRutaFecha(){ $('#fechaRuta').value = $('#fecha').value; if(!$('#tab-ruta').classList.contains('hidden')) renderRutaDia(); }

    function setupRuta(){
      $('#fechaRuta') && $('#fechaRuta').addEventListener('change', ()=>{ $('#fecha').value = $('#fechaRuta').value; renderLista(); renderRutaDia(); });
      $('#hoyRuta') && $('#hoyRuta').addEventListener('click', ()=>{ $('#fechaRuta').value = todayStr(); $('#fecha').value = $('#fechaRuta').value; renderLista(); renderRutaDia(); });
      $('#imprimirRuta') && $('#imprimirRuta').addEventListener('click', ()=> window.print());
    }

    // Tema
    const THEME_KEY = 'theme';
    function setTheme(mode){
      if(mode==='light'){
        document.documentElement.style.setProperty('--bg','#f7f8fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--ink','#0b0c0e');
        document.documentElement.style.setProperty('--muted','#4a5568');
        document.documentElement.style.setProperty('--line','#e6e8ee');
      } else {
        document.documentElement.removeAttribute('style');
      }
      try{ safeStorage.setItem(THEME_KEY, mode); }catch(_){ }
    }
    function setupTheme(){
      const mode = (safeStorage.getItem(THEME_KEY)||'dark'); setTheme(mode);
      $('#toggleTheme') && $('#toggleTheme').addEventListener('click', ()=>{ const mode = (safeStorage.getItem(THEME_KEY)==='light' ? 'dark' : 'light'); setTheme(mode); });
    }

    // Init
    function init(){
      // fecha por defecto
      if($('#fecha')){ if(!$('#fecha').value) $('#fecha').value = todayStr(); }
      if($('#fechaRuta')){ if(!$('#fechaRuta').value) $('#fechaRuta').value = $('#fecha')?.value || todayStr(); }
      setupTheme();
      setupTabs();
      setupPlanEvents();
      setupClientes();
      setupRuta();
      renderClientesAdmin();
      renderLista();
      renderRutas();
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
