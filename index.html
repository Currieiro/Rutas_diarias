<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador Diario de Clientes</title>
  <style>
    :root{
      --bg:#0b0c0e; --card:#121419; --ink:#eaeef3; --muted:#aab3c2; --accent:#5ee6a5; --line:#232731;
      --danger:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    h1{font-size:clamp(1.2rem,2.8vw,1.8rem);margin:0}
    .wrap{max-width:1050px;margin:auto;padding:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="date"],input[type="text"],input[type="search"],textarea,button,.pill,select{border:1px solid var(--line);background:#0e1015;color:#eaeef3;padding:12px 14px;border-radius:12px}
    input[type="text"],input[type="search"],textarea{width:100%}
    input.lg{font-size:1.05rem;padding:14px 16px}
    textarea{min-height:120px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#19c37d,#0aa56a);border:none;color:#04130b;font-weight:700}
    button.ghost{background:transparent}
    button.danger{background:#2a1416;border:1px solid #5a2126;color:#ffb3b8}
    button.warn{background:#2a2312;border:1px solid #57481a;color:#ffe8a3}
    .toolbar{gap:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-top:14px}
    .item{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:12px}
    .item input[type="checkbox"]{transform:scale(1.25);margin-top:3px}
    .muted{color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .pill{user-select:none}
    .pill.active{outline:2px solid var(--accent);}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hidden{display:none}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .right{justify-content:flex-end}
    .checkall{display:flex;align-items:center;gap:8px}
    .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
    .hint{font-size:13px;color:var(--muted)}
    .searchWrap{display:flex;gap:8px;align-items:center;min-width:320px}
    .searchWrap button{padding:10px 12px}
    ol.route{margin:0;padding-left:22px}
    ol.route li{margin:6px 0}
    .visit{display:flex;align-items:center;gap:10px}
    .visit.done span{opacity:.7;text-decoration:line-through}
    .visit .tick{transform:scale(1.2)}
    .status{margin:-8px 0 10px 0; padding:8px 12px; border-radius:10px; background:#201a13; border:1px solid #3a2f22; color:#ffedc2; font-size:13px}
    .ok{background:#132019;border-color:#284a33;color:#c6ffd7}
    @media (max-width:860px){.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="margin-bottom:16px">
      <h1>Planificador diario de clientes</h1>
      <span class="badge" id="version">v1.5</span>
      <div class="grow"></div>
      <button class="ghost" id="toggleTheme" title="Cambiar tema">üåì</button>
    </div>

    <div id="status" class="status">Cargando‚Ä¶</div>

    <div class="card">
      <div class="tabs">
        <div class="pill active" data-tab="plan">üóìÔ∏è Plan diario</div>
        <div class="pill" data-tab="ruta">üß≠ Ruta del d√≠a</div>
        <div class="pill" data-tab="rutas">üì¶ Rutas predefinidas</div>
        <div class="pill" data-tab="clientes">üë• Clientes</div>
        <div class="pill" data-tab="ayuda">‚ùì Ayuda</div>
      </div>

      <!-- PLAN DIARIO -->
      <section id="tab-plan">
        <div class="row toolbar">
          <label>
            <span class="muted">Fecha</span><br>
            <input type="date" id="fecha" />
          </label>
          <button id="hoy">Hoy</button>

          <div class="grow"></div>

          <div class="searchWrap grow" title="Buscar y limpiar con la X">
            <div class="grow">
              <span class="muted">Buscar cliente</span><br>
              <input type="search" class="lg" id="buscador" placeholder="Escribe para filtrar‚Ä¶" />
            </div>
            <button id="clearSearch" title="Borrar b√∫squeda">‚úï</button>
          </div>

          <label class="checkall">
            <input type="checkbox" id="toggleAll"> Seleccionar todos
          </label>

          <select id="selectRuta">
            <option value="">Rutas predefinidas‚Ä¶</option>
            <option value="R-1">R-1</option>
            <option value="R-2">R-2</option>
            <option value="R-3">R-3</option>
            <option value="R-4">R-4</option>
            <option value="R-5">R-5</option>
          </select>
          <button id="aplicarRuta">Aplicar</button>

          <button class="primary" id="guardar">Guardar d√≠a</button>
          <button class="warn" id="vaciar">Vaciar d√≠a</button>
          <button id="imprimir">Imprimir</button>
          <button id="exportar">Exportar</button>
          <button id="importarBtn">Importar</button>
          <input type="file" id="importar" accept="application/json" class="hidden" />
          <button id="forzarRender">Forzar render</button>
          <button id="resetApp" class="danger">Reset app</button>
        </div>

        <div class="foot"><span class="muted">Clientes visibles: <span id="count"></span></span><span class="muted">Los datos se guardan en este navegador.</span></div>
        <div id="lista" class="grid" aria-live="polite"></div>
      </section>

      <!-- RUTA DEL D√çA -->
      <section id="tab-ruta" class="hidden">
        <div class="row toolbar">
          <label>
            <span class="muted">Fecha</span><br>
            <input type="date" id="fechaRuta" />
          </label>
          <button id="hoyRuta">Hoy</button>
          <div class="grow"></div>
          <button id="imprimirRuta">Imprimir ruta</button>
        </div>
        <p class="hint">Marca cada visita como <em>hecha</em>. Se guarda por fecha y cliente.</p>
        <ol class="route" id="rutaLista"></ol>
      </section>

      <!-- RUTAS PREDEFINIDAS -->
      <section id="tab-rutas" class="hidden">
        <h3>Rutas predefinidas (R-1 a R-5)</h3>
        <p class="hint">Edita su contenido y apl√≠calas a cualquier d√≠a. Puedes tambi√©n guardar la selecci√≥n actual en una ruta. (Las rutas con nombre R-1‚Ä¶R-5 siempre existir√°n).</p>

        <div id="rutasBox" class="grid"></div>
      </section>

      <!-- CLIENTES -->
      <section id="tab-clientes" class="hidden">
        <div class="split">
          <div>
            <h3>Listado actual</h3>
            <p class="hint">Este listado se guarda en el navegador. Puedes a√±adir, borrar o restablecer.</p>
            <div class="row">
              <input class="grow" type="text" id="nuevoCliente" placeholder="Nombre del nuevo cliente" />
              <button id="addCliente">A√±adir</button>
              <button class="danger" id="resetClientes" title="Restablecer a la lista original">Reset</button>
            </div>
            <div id="clientesList" class="grid" style="margin-top:10px"></div>
          </div>
          <div>
            <h3>Alta masiva</h3>
            <p class="hint">Pega uno por l√≠nea. Evitamos duplicados autom√°ticamente.</p>
            <textarea id="bulk"></textarea>
            <div class="row right">
              <button id="bulkAdd">A√±adir en bloque</button>
            </div>
          </div>
        </div>
      </section>

      <!-- AYUDA -->
      <section id="tab-ayuda" class="hidden">
        <h3>C√≥mo usarlo</h3>
        <ol>
          <li>Elige una <strong>fecha</strong> o pulsa <em>Hoy</em>.</li>
          <li>Marca los <strong>clientes</strong> que quieras visitar ese d√≠a.</li>
          <li>Pulsa <strong>Guardar d√≠a</strong>. ¬°Listo!</li>
          <li>Para usar una <strong>ruta predefinida</strong>, esc√≥gela en el desplegable y pulsa <em>Aplicar</em>.</li>
        </ol>
        <p class="hint">Exporta tus datos antes de cambiar de ordenador o borrar la cach√©.</p>
      </section>
    </div>

    <div class="foot">
      <span>Hecho con ‚òïÔ∏è para que organizes tus rutas sin l√≠os.</span>
      <span class="muted">Datos locales ‚Ä¢ Sin conexi√≥n ‚Ä¢ 100% tuyo</span>
    </div>
  </div>

  <script>
  (function(){
    var statusEl = document.getElementById('status');
    function setStatus(msg, ok){ statusEl.className = 'status'+(ok?' ok':''); statusEl.textContent = msg; }
    function showError(e){ setStatus('‚ö†Ô∏è '+(e && (e.message||e)),''); }
    window.addEventListener('error', function(e){ showError(e.error||e.message); });
    window.addEventListener('unhandledrejection', function(e){ showError(e.reason||'Error desconocido'); });

    function todayStr(){ var now=new Date(); var yyyy=now.getFullYear(); var mm=('0'+(now.getMonth()+1)).slice(-2); var dd=('0'+now.getDate()).slice(-2); return yyyy+'-'+mm+'-'+dd; }
    function getDateFromInput(sel){ var el=document.querySelector(sel); if(!el||!el.value){ if(el) el.value=todayStr(); } var d=new Date(el?el.value:todayStr()); return isNaN(d)? new Date(todayStr()) : d; }
    function dateKey(d){ var dd=(d instanceof Date&&!isNaN(d))?d:new Date(todayStr()); var yyyy=dd.getFullYear(); var mm=('0'+(dd.getMonth()+1)).slice(-2); var di=('0'+dd.getDate()).slice(-2); return yyyy+'-'+mm+'-'+di; }

    var safeStorage=(function(){ try{ var t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }catch(_){ var mem={}; return {getItem:function(k){return mem[k]||null;}, setItem:function(k,v){mem[k]=String(v);}, removeItem:function(k){delete mem[k];}}; }})();

    var DEFAULT_CLIENTES=[
      "RTE L'ESTONETA","RTE PIPA","CUATRECASAS","SET POINT","MARIMBA","EL PEDREGAL","LES CATIVAS","BAR RESTAURANTE POMA","A PROP TEU","TIENDA RONDA SANT ANTONI","O BURATO BAR","BAR CAFETERIA MARIANA","MANDONI PEDRALBES","TEATRO NACIONAL DE CATALUNYA","RESTAURANT CENT FOCS","HOTEL MESON CASTILLA","BAR RTE LEPANTO","CAFE ILUSIONA BY MUXIA","EL MOLI PAN Y CAFE SANTS","OMBU, RTE","DAMAIA, BAR","EXE RAMBLAS BOQUERIA","PLEASE PLATS","RESTAURANTE HONKAKU II","O CANTO RESTAURANTE","SARA TAPES","HOTEL SB GLOW","TOC HOSTAL GRAN VIA","HOTEL SB ICARIA BARCELONA","CAFETERIA DOMI","TIENDA JOAQUIM VALLS","GOIKO GRILL CARRER CAN SEGALAR","EL FOC DEN CANIGO","GOIKO GRILL GRAN VIA DE LES CORTS","LA FILOMENA BAR","GOIKO GRILL CARRER INDEPENDENCIA","GOIKO GRILL BRUC","GOIKO GRILL C.C. SOM MULTIESPAI","EUROSTARS ANGLI","BAR CA√ëAS","GOIKO GRILL PASSEIG SANT JOAN","GARBI","SETEMBRE","LA CASSOLETA","GOIKO GRILL CARRER D'ARIBAU","TIENDA TORRES I BAGES","ATICCO PASSEIG DE GR√ÄCIA CANTINA","EXE LAIETANA PALACE","TIENDA MERIDIANA II","EUROSTARS CRISTAL PALACE","RIAS DE GALICIA RTE","MIRADOR SANT JUST","IKONIK RAMBLAS","GOIKO MARAGALL","CASA DE TAPAS LA CA√ëOTA","GOIKO GRILL LAIETANA","ALTIMA HOSPITALET GRAN VIA","RINCON GALEGO","BAR EUROPA","RESTAURANTE SUKAPA","ANTOTXO","RTE ZHU ZHU","EXE PLAZA CATALUNYA 4","EUROSTARS MONUMENTAL","EUROSTARS MITRE","TIENDA SANT VICEN√á DELS HORTS","FORN VELL INDUSTRIA","FORN VELL CLARET","TIENDA VIA JULIA","VALDAURA","PIPA S CAFETERIA","RESTAURANTE LA GORMANDA","BAR BUC","TOSTA BAR","ADELITA RESTAURANTE","MOLI PAN Y CAFE ZONA FRANCA","LOKAL","BATEA","BAR LOS PINOS 2","TSUKIMI","LA PALMERA","EL MIRALL DELS ENCANTS","LOMO ALTO","HOTEL ORIENTE","HOTEL ARENAS","HOTEL TRES TORRES","ESCAIRON","LA RUTA GALLEGA","TIENDA CLOT","LA BRASA RESTAURANTE","RTE ANCARES","A DUES RODES","CAFETERIA RONDA SANT BOI","TIENDA LES CORTS","LA LLAR DEL MERCAT 2 SANT BOI","HOTEL SB WIN SANT FELIU","LOS 3 ARCOS BAR","RTE MAMETORA","BOEDO","O RINCON GALLEGO MERIDIANA","R.U. COSMOPOLITAN","FRANKFURT TOLIK","CIURIS","CAFETERIA LEROY MERLIN SANT BOI","BAR DE BO","ESCUELA JUDICIAL BCN","O MEU LAR","EL CARQUINYOLI","NON SOLO CREPS","GREENVITA NUMANCIA","K10 SUSHI SANT BOI","EL RACONET D'URGELL","TIENDA EL TALLER SANT BOI","CHALITO BCN.","HOTEL FRONTAIR CONGRESS","CLUB TIRO MONTJUIT","FRANKFURT SANTS","R.U. EMILIE DE VILLENUEVE","SOLUCIONS SOCIALS INSERCIO","ALTIMA SANT BOI","FUNDACIO ASPACE CATALUNYA","GREEN VITA GLORIES","ATICCO PASSEIG DE GR√ÄCIA OFICINA","70/30","ORDAL","PESSEBRE","BUFFS DE FARINA","TIENDA TALLER VALLDAURA","ARTESANO","HELADER√çA ADRI GELATIAMO"
    ];

    var DEFAULT_RUTAS={'R-1':[],'R-2':[],'R-3':[],'R-4':[],'R-5':[]};
    var KEYS={clientes:'clientes',planes:'planes',rutas:'rutasPredef',hechos:'visitasHechas',theme:'theme'};

    function load(key, fb){ try{ var raw=safeStorage.getItem(key); return raw? JSON.parse(raw) : fb; }catch(_){ return fb; } }
    function save(key, val){ try{ safeStorage.setItem(key, JSON.stringify(val)); }catch(_){} }

    var CLIENTES = load(KEYS.clientes, DEFAULT_CLIENTES.slice());
    if(!CLIENTES || !CLIENTES.length){ CLIENTES = DEFAULT_CLIENTES.slice(); save(KEYS.clientes, CLIENTES); }
    var PLANES   = load(KEYS.planes, {});
    var RUTAS    = Object.assign({}, DEFAULT_RUTAS, load(KEYS.rutas, {}));
    var HECHOS   = load(KEYS.hechos, {});

    function qs(sel){ return document.querySelector(sel); }
    function qsa(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

    function renderLista(){
      var cont = qs('#lista'); if(!cont) return;
      var filtro = (qs('#buscador') && qs('#buscador').value || '').toLowerCase();
      var key = dateKey(getDateFromInput('#fecha'));
      var seleccionados = new Set(PLANES[key]||[]);
      var visibles = CLIENTES.filter(function(c){ return c.toLowerCase().indexOf(filtro) !== -1; });
      cont.innerHTML='';
      if(visibles.length===0){
        var empty=document.createElement('div'); empty.className='item'; empty.innerHTML='<div class="muted">No hay clientes que coincidan con la b√∫squeda.</div>'; cont.appendChild(empty);
      }
      visibles.forEach(function(nombre){
        var id='c-'+nombre.replace(/[^a-z0-9]+/gi,'-');
        var div=document.createElement('label'); div.className='item';
        div.innerHTML='<input type="checkbox" id="'+id+'"> <div><div><strong>'+nombre+'</strong></div><div class="muted">Pulsa para incluir en el plan del d√≠a.</div></div>';
        var chk=div.querySelector('input'); chk.checked = seleccionados.has(nombre);
        chk.addEventListener('change', function(){
          if(chk.checked){ seleccionados.add(nombre); } else { seleccionados.delete(nombre); }
          PLANES[key] = Array.from(seleccionados); save(KEYS.planes, PLANES); updateToggleAll();
        });
        cont.appendChild(div);
      });
      var cnt=qs('#count'); if(cnt) cnt.textContent = visibles.length+' / '+CLIENTES.length;
      updateToggleAll();
    }

    function updateToggleAll(){
      var key=dateKey(getDateFromInput('#fecha'));
      var seleccionados=new Set(PLANES[key]||[]);
      var filtro=(qs('#buscador') && qs('#buscador').value || '').toLowerCase();
      var visibles=CLIENTES.filter(function(c){ return c.toLowerCase().indexOf(filtro)!==-1; });
      var allSelected = visibles.length>0 && visibles.every(function(c){ return seleccionados.has(c); });
      var t=qs('#toggleAll'); if(t) t.checked=allSelected;
    }

    function renderRutaDia(){
      var fechaRuta=getDateFromInput('#fechaRuta');
      var key=dateKey(fechaRuta);
      var lista=PLANES[key]||[];
      var hechos=HECHOS[key]||{};
      var ol=qs('#rutaLista'); if(!ol) return;
      ol.innerHTML='';
      if(!lista.length){ var li=document.createElement('li'); li.innerHTML='<span class="muted">(No hay clientes seleccionados para este d√≠a)</span>'; ol.appendChild(li); return; }
      lista.forEach(function(c){
        var li=document.createElement('li'); var checked=!!hechos[c];
        li.innerHTML='<label class="visit '+(checked?'done':'')+'"><input class="tick" type="checkbox" '+(checked?'checked':'')+'><span>'+c+'</span></label>';
        var cb=li.querySelector('input');
        cb.addEventListener('change', function(){
          var k=dateKey(getDateFromInput('#fechaRuta'));
          if(!HECHOS[k]) HECHOS[k]={}; HECHOS[k][c]=cb.checked; save(KEYS.hechos, HECHOS);
          li.querySelector('.visit').classList.toggle('done', cb.checked);
        });
        ol.appendChild(li);
      });
    }

    function renderRutas(){
      var box=qs('#rutasBox'); if(!box) return; box.innerHTML='';
      ['R-1','R-2','R-3','R-4','R-5'].forEach(function(k){
        var arr=RUTAS[k]||[];
        var div=document.createElement('div'); div.className='item';
        div.innerHTML = ''+
          '<div class="grow">'+
          '  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><strong>'+k+'</strong> <span class="muted">('+arr.length+' clientes)</span></div>'+
          '  <details style="margin-top:6px"><summary>Ver lista</summary><ul style="margin:6px 0 0 18px; padding:0">'+(arr.length? arr.map(function(c){return '<li>'+c+'</li>';}).join(''):'<li class="muted">(vac√≠a)</li>')+'</ul></details>'+
          '  <details style="margin-top:6px"><summary>Editar</summary><p class="hint">Pega uno por l√≠nea. Se eliminan duplicados y nombres vac√≠os.</p><textarea data-edit="'+k+'">'+arr.join('
')+'</textarea><div class="row right" style="margin-top:6px"><button data-save="'+k+'">Guardar cambios</button><button class="danger" data-clear="'+k+'">Vaciar</button><button class="warn" data-resetk="'+k+'">Reset (dejar vac√≠a)</button></div></details>'+
          '</div>'+
          '<div style="display:flex; flex-direction:column; gap:8px; min-width:180px">'+
          '  <button data-apply="'+k+'">Aplicar al d√≠a ‚ñ∂</button>'+
          '  <button data-store="'+k+'">Guardar selecci√≥n actual en '+k+'</button>'+
          '</div>';
        box.appendChild(div);
      });
      qsa('[data-apply]').forEach(function(btn){ btn.addEventListener('click', function(){ var k=btn.getAttribute('data-apply'); var key=dateKey(getDateFromInput('#fecha')); PLANES[key]=(RUTAS[k]||[]).filter(function(c){return CLIENTES.indexOf(c)!==-1;}); save(KEYS.planes, PLANES); renderLista(); alert('Ruta '+k+' aplicada al d√≠a.'); }); });
      qsa('[data-store]').forEach(function(btn){ btn.addEventListener('click', function(){ var k=btn.getAttribute('data-store'); var key=dateKey(getDateFromInput('#fecha')); var lista=PLANES[key]||[]; RUTAS[k]=lista.filter(function(c){return CLIENTES.indexOf(c)!==-1;}); save(KEYS.rutas, RUTAS); renderRutas(); alert('Selecci√≥n actual guardada en '+k+'.'); }); });
      qsa('[data-save]').forEach(function(btn){ btn.addEventListener('click', function(){ var k=btn.getAttribute('data-save'); var ta=qs('textarea[data-edit="'+k+'"]'); var lines=(ta && ta.value || '').split(/
?
/).map(function(s){return s.trim();}).filter(Boolean); var set={}; var out=[]; lines.forEach(function(x){ if(!set[x]){ set[x]=1; out.push(x); } }); RUTAS[k]=out.filter(function(c){return CLIENTES.indexOf(c)!==-1;}); save(KEYS.rutas, RUTAS); renderRutas(); alert('Ruta '+k+' actualizada.'); }); });
      qsa('[data-clear]').forEach(function(btn){ btn.addEventListener('click', function(){ var k=btn.getAttribute('data-clear'); if(confirm('¬øVaciar por completo la ruta '+k+'?')){ RUTAS[k]=[]; save(KEYS.rutas, RUTAS); renderRutas(); } }); });
      qsa('[data-resetk]').forEach(function(btn){ btn.addEventListener('click', function(){ var k=btn.getAttribute('data-resetk'); if(confirm('Esto deja la ruta '+k+' vac√≠a (predefinida existe, pero sin clientes). ¬øContinuar?')){ RUTAS[k]=[]; save(KEYS.rutas, RUTAS); renderRutas(); } }); });
    }

    function setupTabs(){
      qsa('.pill').forEach(function(p){ p.addEventListener('click', function(){ qsa('.pill').forEach(function(x){ x.classList.remove('active'); }); p.classList.add('active'); var tab=p.getAttribute('data-tab'); qs('#tab-plan').classList.toggle('hidden', tab!=='plan'); qs('#tab-ruta').classList.toggle('hidden', tab!=='ruta'); qs('#tab-rutas').classList.toggle('hidden', tab!=='rutas'); qs('#tab-clientes').classList.toggle('hidden', tab!=='clientes'); qs('#tab-ayuda').classList.toggle('hidden', tab!=='ayuda'); if(tab==='ruta'){ renderRutaDia(); } if(tab==='rutas'){ renderRutas(); } }); });
    }

    function setupPlanEvents(){
      if(qs('#fecha')) qs('#fecha').addEventListener('change', function(){ renderLista(); syncRutaFecha(); });
      if(qs('#hoy')) qs('#hoy').addEventListener('click', function(){ qs('#fecha').value=todayStr(); renderLista(); syncRutaFecha(); });
      if(qs('#buscador')) qs('#buscador').addEventListener('input', renderLista);
      if(qs('#clearSearch')) qs('#clearSearch').addEventListener('click', function(){ qs('#buscador').value=''; renderLista(); qs('#buscador').focus(); });
      if(qs('#toggleAll')) qs('#toggleAll').addEventListener('change', function(e){ var key=dateKey(getDateFromInput('#fecha')); var filtro=(qs('#buscador')&&qs('#buscador').value||'').toLowerCase(); var visibles=CLIENTES.filter(function(c){return c.toLowerCase().indexOf(filtro)!==-1;}); if(e.target.checked){ var set=new Set(PLANES[key]||[]); visibles.forEach(function(v){ set.add(v); }); PLANES[key]=Array.from(set);} else { var remain=new Set(PLANES[key]||[]); visibles.forEach(function(v){ remain.delete(v); }); PLANES[key]=Array.from(remain);} save(KEYS.planes, PLANES); renderLista(); });
      if(qs('#guardar')) qs('#guardar').addEventListener('click', function(){ alert('¬°D√≠a guardado!'); });
      if(qs('#vaciar')) qs('#vaciar').addEventListener('click', function(){ if(confirm('¬øSeguro que quieres vaciar la selecci√≥n de este d√≠a?')){ var key=dateKey(getDateFromInput('#fecha')); PLANES[key]=[]; save(KEYS.planes, PLANES); delete HECHOS[key]; save(KEYS.hechos, HECHOS); renderLista(); }});
      if(qs('#imprimir')) qs('#imprimir').addEventListener('click', function(){ window.print(); });
      if(qs('#exportar')) qs('#exportar').addEventListener('click', function(){ var data={clientes:CLIENTES,planes:PLANES,rutas:RUTAS,hechos:HECHOS}; var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='planificador_clientes.json'; a.click(); URL.revokeObjectURL(a.href); });
      if(qs('#importarBtn')) qs('#importarBtn').addEventListener('click', function(){ qs('#importar').click(); });
      if(qs('#importar')) qs('#importar').addEventListener('change', function(e){ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var data=JSON.parse(r.result); if(Array.isArray(data.clientes)){ CLIENTES=Array.from(new Set(data.clientes)); save(KEYS.clientes, CLIENTES); } if(data.planes && typeof data.planes==='object'){ PLANES=data.planes; save(KEYS.planes, PLANES); } if(data.rutas && typeof data.rutas==='object'){ RUTAS=Object.assign({}, DEFAULT_RUTAS, data.rutas); save(KEYS.rutas, RUTAS); } if(data.hechos && typeof data.hechos==='object'){ HECHOS=data.hechos; save(KEYS.hechos, HECHOS); } renderClientesAdmin(); renderLista(); renderRutas(); alert('Datos importados correctamente.'); }catch(err){ alert('Archivo no v√°lido.'); } }; r.readAsText(f); e.target.value=''; });
      if(qs('#aplicarRuta')) qs('#aplicarRuta').addEventListener('click', function(){ var sel=(qs('#selectRuta') && qs('#selectRuta').value) || ''; if(!sel) return alert('Elige una ruta predefinida.'); var key=dateKey(getDateFromInput('#fecha')); PLANES[key]=Array.from(new Set(RUTAS[sel]||[])).filter(function(c){return CLIENTES.indexOf(c)!==-1;}); save(KEYS.planes, PLANES); renderLista(); alert('Ruta '+sel+' aplicada al d√≠a.'); });
      if(qs('#forzarRender')) qs('#forzarRender').addEventListener('click', function(){ try{ renderLista(); renderRutaDia(); renderRutas(); setStatus('Render forzado OK', true);}catch(e){ showError(e); }});
      if(qs('#resetApp')) qs('#resetApp').addEventListener('click', function(){ if(confirm('Esto borra datos guardados en este navegador (clientes, planes, rutas, hechos). ¬øSeguro?')){ try{ safeStorage.removeItem(KEYS.clientes); safeStorage.removeItem(KEYS.planes); safeStorage.removeItem(KEYS.rutas); safeStorage.removeItem(KEYS.hechos); location.reload(); }catch(_){ location.reload(); } } });
    }

    function renderClientesAdmin(){ var box=qs('#clientesList'); if(!box) return; box.innerHTML=''; CLIENTES.forEach(function(c,i){ var row=document.createElement('div'); row.className='item'; row.innerHTML='<div class="grow"><strong>'+c+'</strong></div><button class="danger" title="Eliminar">‚úï</button>'; row.querySelector('button').addEventListener('click', function(){ if(confirm('¬øEliminar "'+c+'" del listado?')){ CLIENTES.splice(i,1); save(KEYS.clientes, CLIENTES); renderClientesAdmin(); renderLista(); } }); box.appendChild(row); }); }

    function setupClientes(){ if(qs('#addCliente')) qs('#addCliente').addEventListener('click', function(){ var v=(qs('#nuevoCliente')&&qs('#nuevoCliente').value||'').trim(); if(!v) return; if(CLIENTES.indexOf(v)===-1) CLIENTES.push(v); CLIENTES=Array.from(new Set(CLIENTES)).sort(function(a,b){ return a.localeCompare(b); }); save(KEYS.clientes, CLIENTES); qs('#nuevoCliente').value=''; renderClientesAdmin(); renderLista(); }); if(qs('#bulkAdd')) qs('#bulkAdd').addEventListener('click', function(){ var lines=(qs('#bulk')&&qs('#bulk').value||'').split(/
?
/).map(function(s){return s.trim();}).filter(Boolean); if(!lines.length) return; CLIENTES=Array.from(new Set(CLIENTES.concat(lines))).sort(function(a,b){ return a.localeCompare(b); }); save(KEYS.clientes, CLIENTES); qs('#bulk').value=''; renderClientesAdmin(); renderLista(); }); if(qs('#resetClientes')) qs('#resetClientes').addEventListener('click', function(){ if(confirm('¬øRestablecer el listado a la versi√≥n original?')){ CLIENTES=DEFAULT_CLIENTES.slice(); save(KEYS.clientes, CLIENTES); renderClientesAdmin(); renderLista(); } }); }

    function syncRutaFecha(){ var f=qs('#fecha'); var fr=qs('#fechaRuta'); if(f && fr){ fr.value=f.value; if(!qs('#tab-ruta').classList.contains('hidden')) renderRutaDia(); } }

    function setupRuta(){ if(qs('#fechaRuta')) qs('#fechaRuta').addEventListener('change', function(){ var fr=qs('#fechaRuta'); var f=qs('#fecha'); if(f&&fr){ f.value=fr.value; } renderLista(); renderRutaDia(); }); if(qs('#hoyRuta')) qs('#hoyRuta').addEventListener('click', function(){ var fr=qs('#fechaRuta'); if(fr){ fr.value=todayStr(); var f=qs('#fecha'); if(f) f.value=fr.value; } renderLista(); renderRutaDia(); }); if(qs('#imprimirRuta')) qs('#imprimirRuta').addEventListener('click', function(){ window.print(); }); }

    function setupTheme(){ var mode = (safeStorage.getItem(KEYS.theme)||'dark'); setTheme(mode); var btn=qs('#toggleTheme'); if(btn) btn.addEventListener('click', function(){ var cur=(safeStorage.getItem(KEYS.theme)||'dark'); setTheme(cur==='light'?'dark':'light'); }); }
    function setTheme(mode){ if(mode==='light'){ document.documentElement.style.setProperty('--bg','#f7f8fb'); document.documentElement.style.setProperty('--card','#ffffff'); document.documentElement.style.setProperty('--ink','#0b0c0e'); document.documentElement.style.setProperty('--muted','#4a5568'); document.documentElement.style.setProperty('--line','#e6e8ee'); } else { document.documentElement.removeAttribute('style'); } try{ safeStorage.setItem(KEYS.theme, mode); }catch(_){} }

    function init(){ try{
      if(qs('#fecha') && !qs('#fecha').value) qs('#fecha').value=todayStr();
      if(qs('#fechaRuta') && !qs('#fechaRuta').value) qs('#fechaRuta').value=qs('#fecha')?qs('#fecha').value:todayStr();
      setupTheme(); setupTabs(); setupPlanEvents(); setupClientes(); setupRuta();
      renderClientesAdmin(); renderLista(); renderRutas(); setStatus('Listo ‚úÖ', true);
    }catch(e){ showError(e); }
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  })();
  </script>
</body>
</html>

