<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rutas de Clientes</title>
<style>
  :root { --gap:14px; --pad:14px; --radius:16px; --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  * { box-sizing: border-box; }
  body { font-family: var(--font); margin: 0; background: #f6f7f9; color:#222; }
  header { position: sticky; top:0; background: white; padding: var(--pad); box-shadow: 0 2px 10px rgba(0,0,0,.06); z-index: 2; }
  h1 { font-size: 18px; margin: 0 0 6px; }
  .row { display:flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
  select, input, button, textarea { font-size: 16px; } /* iPhone friendly */
  select, input[type="text"], textarea {
    width: 100%; padding:12px; border:1px solid #d8dbe2; border-radius: var(--radius); background:#fff;
  }
  button {
    padding: 12px 14px; border: none; border-radius: var(--radius); background:#0a7cff; color:white; font-weight:600;
    box-shadow: 0 2px 8px rgba(10,124,255,.25); cursor:pointer;
  }
  button.secondary { background:#eef0f4; color:#222; box-shadow:none; }
  button.warn { background:#ff3b30; }
  main { padding: var(--pad); }
  .card {
    background: white; border:1px solid #e8ebf2; border-radius: var(--radius); padding: var(--pad);
    box-shadow: 0 6px 24px rgba(0,0,0,.04);
  }
  ul { list-style: none; padding:0; margin:0; }
  li {
    display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #edf0f6; border-radius:12px; margin-bottom:10px;
    touch-action: manipulation;
  }
  li.done { opacity:.65; text-decoration: line-through; }
  .toolbar { display:flex; gap:var(--gap); flex-wrap: wrap; margin-top: var(--gap); }
  .muted { color:#6b7280; font-size: 13px; }
  .editor { margin-top: var(--gap); display:none; }
  .badge { background:#eef4ff; color:#0a7cff; font-weight:600; padding: 6px 10px; border-radius:999px; font-size: 12px; }
  .pill { background:#f1f5f9; border-radius:999px; padding: 3px 8px; font-size:12px; }
  .grid { display:grid; gap: var(--gap); }
  .grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .danger-zone { border-top:1px dashed #e5e7eb; margin-top: var(--gap); padding-top: var(--gap); }
  .footer-note { padding: var(--pad); color:#6b7280; font-size:12px; text-align:center; }
</style>
</head>
<body>
  <header>
    <h1>Rutas de Clientes <span class="badge">offline</span></h1>
    <div class="row">
      <label class="pill" for="rutaSelect">Ruta</label>
      <select id="rutaSelect" aria-label="Selecciona una ruta">
        <option value="Lunes">Lunes</option>
        <option value="Martes">Martes</option>
        <option value="Miércoles">Miércoles</option>
        <option value="Jueves">Jueves</option>
        <option value="Viernes">Viernes</option>
      </select>
      <div class="toolbar">
        <button id="btnEditar" class="secondary">Editar rutas</button>
        <button id="btnResetRuta" class="secondary">Reiniciar visitas de esta ruta</button>
        <button id="btnResetTodas" class="secondary">Reiniciar TODAS las visitas</button>
      </div>
    </div>
  </header>

  <main>
    <section id="lista" class="card">
      <h2 style="margin:0 0 10px;">Clientes de <span id="rutaTitulo">Lunes</span></h2>
      <ul id="clientesUl" aria-live="polite"></ul>
      <p id="vacioMsg" class="muted" style="display:none;">No hay clientes en esta ruta. Pulsa <b>Editar rutas</b> para añadir.</p>
    </section>

    <section id="editor" class="card editor" aria-hidden="true">
      <h3 style="margin:0 0 10px;">Editar <span id="rutaEditTitulo">Lunes</span></h3>
      <div class="grid">
        <input id="nuevoCliente" type="text" placeholder="Nombre del cliente (ej. BAR PEPE)">
        <div class="grid cols-2">
          <button id="btnAdd">Añadir cliente</button>
          <button id="btnGuardar" class="secondary">Guardar cambios</button>
        </div>
      </div>
      <ul id="editorUl" style="margin-top:12px;"></ul>

      <div class="danger-zone">
        <div class="grid">
          <button id="btnExport" class="secondary">Exportar rutas (copia/pega)</button>
          <button id="btnImport" class="secondary">Importar rutas (pegar JSON)</button>
          <textarea id="jsonBox" rows="6" placeholder='Aquí verás/pegarás el JSON de tus rutas' style="display:none;"></textarea>
        </div>
      </div>
    </section>
  </main>

  <div class="footer-note">Consejo ninja: añade esta página a la pantalla de inicio del iPhone para abrirla como app.</div>

<script>
/* ========= Claves de almacenamiento ========= */
const LS_ROUTES_KEY = 'routes_v1';                 // rutas predefinidas (editables)
const LS_PROGRESS_PREFIX = 'progress_v1_';         // progreso por ruta (checks)

/* ========= Rutas por defecto (edítalas o impórtalas) ========= */
const DEFAULT_ROUTES = {
  "Lunes":    ["RTE L'ESTONETA","RTE PIPA","MARIMBA"],
  "Martes":   ["EL PEDREGAL","LES CATIVAS","BAR RESTAURANTE POMA"],
  "Miércoles":[],
  "Jueves":   [],
  "Viernes":  []
};

/* ========= Utilidades ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function loadRoutes() {
  try {
    const raw = localStorage.getItem(LS_ROUTES_KEY);
    if (!raw) return { ...DEFAULT_ROUTES };
    const parsed = JSON.parse(raw);
    // Asegurar que existan las 5 rutas aunque falten en el JSON
    return { ...DEFAULT_ROUTES, ...parsed };
  } catch (_) {
    return { ...DEFAULT_ROUTES };
  }
}
function saveRoutes(routes) {
  localStorage.setItem(LS_ROUTES_KEY, JSON.stringify(routes));
}

function loadProgress(routeName) {
  try {
    const raw = localStorage.getItem(LS_PROGRESS_PREFIX + routeName);
    return raw ? new Set(JSON.parse(raw)) : new Set();
  } catch (_) { return new Set(); }
}
function saveProgress(routeName, set) {
  localStorage.setItem(LS_PROGRESS_PREFIX + routeName, JSON.stringify(Array.from(set)));
}

function toast(msg) {
  // Simple vibración visual (accesible y mínima para iPhone)
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.left='50%'; t.style.bottom='18px'; t.style.transform='translateX(-50%)';
  t.style.background='rgba(0,0,0,.85)'; t.style.color='white'; t.style.padding='10px 14px'; t.style.borderRadius='999px';
  t.style.fontSize='14px'; t.style.zIndex='9999';
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; }, 900);
  setTimeout(()=> t.remove(), 1300);
}

/* ========= Estado de la app ========= */
let ROUTES = loadRoutes();                  // objeto {Ruta:[clientes...]}
let CURRENT_ROUTE = $('#rutaSelect').value; // string
let PROGRESS = loadProgress(CURRENT_ROUTE); // Set de clientes hechos (por nombre exacto)

/* ========= Pintar lista de clientes ========= */
function renderList() {
  $('#rutaTitulo').textContent = CURRENT_ROUTE;
  const ul = $('#clientesUl');
  ul.innerHTML = '';
  const clientes = ROUTES[CURRENT_ROUTE] || [];
  $('#vacioMsg').style.display = clientes.length ? 'none' : 'block';

  clientes.forEach(name => {
    const li = document.createElement('li');
    const cb = document.createElement('input');
    cb.type='checkbox';
    cb.checked = PROGRESS.has(name);
    cb.setAttribute('aria-label', `Visita a ${name}`);
    cb.addEventListener('change', () => {
      if (cb.checked) PROGRESS.add(name); else PROGRESS.delete(name);
      saveProgress(CURRENT_ROUTE, PROGRESS);
      li.classList.toggle('done', cb.checked);
    });
    const label = document.createElement('label');
    label.textContent = name;
    li.appendChild(cb);
    li.appendChild(label);
    li.classList.toggle('done', cb.checked);
    ul.appendChild(li);
  });
}

/* ========= Cambio de ruta ========= */
$('#rutaSelect').addEventListener('change', e => {
  CURRENT_ROUTE = e.target.value;
  PROGRESS = loadProgress(CURRENT_ROUTE);
  // Ocultar editor si estaba abierto, para evitar confusiones
  closeEditor();
  renderList();
});

/* ========= Reiniciar visitas ========= */
$('#btnResetRuta').addEventListener('click', () => {
  const ok = confirm(`¿Reiniciar las visitas marcadas de "${CURRENT_ROUTE}"?`);
  if (!ok) return;
  PROGRESS = new Set();
  saveProgress(CURRENT_ROUTE, PROGRESS);
  renderList();
  toast('Ruta reiniciada');
});
$('#btnResetTodas').addEventListener('click', () => {
  const ok = confirm('¿Reiniciar TODAS las visitas marcadas (todas las rutas)?');
  if (!ok) return;
  Object.keys(ROUTES).forEach(r => localStorage.removeItem(LS_PROGRESS_PREFIX + r));
  PROGRESS = loadProgress(CURRENT_ROUTE);
  renderList();
  toast('Todas las visitas reiniciadas');
});

/* ========= Editor de rutas (añadir/quitar clientes) ========= */
const editor = $('#editor');
const editorUl = $('#editorUl');
const nuevoCliente = $('#nuevoCliente');

function openEditor() {
  $('#rutaEditTitulo').textContent = CURRENT_ROUTE;
  editorUl.innerHTML = '';
  const lista = ROUTES[CURRENT_ROUTE] || [];
  lista.forEach((name, idx) => {
    const li = document.createElement('li');
    const span = document.createElement('span'); span.textContent = name; span.style.flex='1';
    const del = document.createElement('button'); del.textContent='Eliminar'; del.className='secondary';
    del.addEventListener('click', () => {
      ROUTES[CURRENT_ROUTE].splice(idx,1);
      saveRoutes(ROUTES);
      // También quitamos el progreso de ese cliente en esta ruta si existía
      PROGRESS.delete(name); saveProgress(CURRENT_ROUTE, PROGRESS);
      openEditor(); // recargar editor
      renderList(); // refrescar lista principal
    });
    li.appendChild(span); li.appendChild(del);
    editorUl.appendChild(li);
  });
  editor.style.display='block';
  editor.setAttribute('aria-hidden','false');
  $('#btnEditar').textContent = 'Cerrar editor';
}
function closeEditor() {
  editor.style.display='none';
  editor.setAttribute('aria-hidden','true');
  $('#btnEditar').textContent = 'Editar rutas';
}
$('#btnEditar').addEventListener('click', () => {
  const open = editor.style.display === 'block';
  open ? closeEditor() : openEditor();
});

$('#btnAdd').addEventListener('click', () => {
  const name = (nuevoCliente.value || '').trim();
  if (!name) { toast('Escribe un nombre'); return; }
  if (!ROUTES[CURRENT_ROUTE]) ROUTES[CURRENT_ROUTE] = [];
  ROUTES[CURRENT_ROUTE].push(name);
  saveRoutes(ROUTES);
  nuevoCliente.value='';
  openEditor();   // repinta editor
  renderList();   // repinta lista
  toast('Cliente añadido');
});

$('#btnGuardar').addEventListener('click', () => {
  saveRoutes(ROUTES);
  toast('Rutas guardadas');
});

/* ========= Exportar / Importar (backup por texto) ========= */
const jsonBox = $('#jsonBox');
$('#btnExport').addEventListener('click', () => {
  jsonBox.style.display='block';
  jsonBox.value = JSON.stringify(ROUTES, null, 2);
  jsonBox.focus(); jsonBox.select();
  toast('Copiado listo para pegar');
});
$('#btnImport').addEventListener('click', () => {
  const visible = jsonBox.style.display === 'block';
  if (!visible) { jsonBox.style.display='block'; jsonBox.value=''; jsonBox.placeholder='Pega aquí tu JSON y vuelve a pulsar Importar'; return; }
  try {
    const parsed = JSON.parse(jsonBox.value);
    // Validación mínima: asegurar 5 rutas
    const needed = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
    needed.forEach(k => { if (!Array.isArray(parsed[k])) parsed[k]=[]; });
    ROUTES = parsed;
    saveRoutes(ROUTES);
    PROGRESS = loadProgress(CURRENT_ROUTE);
    renderList();
    openEditor();
    toast('Rutas importadas');
  } catch (e) {
    alert('JSON inválido. Revisa que esté bien formado.');
  }
});

/* ========= Inicio ========= */
(function init() {
  // Asegurar que existan todas las rutas
  const needed = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
  let changed = false;
  needed.forEach(k => { if (!Array.isArray(ROUTES[k])) { ROUTES[k]=[]; changed=true; } });
  if (changed) saveRoutes(ROUTES);
  renderList();
})();
</script>
</body>
</html>
