<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Rutas de Clientes</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<style>
  :root { --gap:14px; --pad:14px; --radius:16px; --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  * { box-sizing: border-box; }
  body { font-family: var(--font); margin: 0; background:#f6f7f9; color:#222; }
  header { position: sticky; top:0; background:#fff; padding: var(--pad); box-shadow: 0 2px 10px rgba(0,0,0,.06); z-index: 2; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  .row { display:flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
  select, input, button, textarea { font-size:16px; }
  select, input[type="text"], textarea {
    width: 100%; padding:12px; border:1px solid #d8dbe2; border-radius: var(--radius); background:#fff;
  }
  button {
    padding: 12px 14px; border: none; border-radius: var(--radius); background:#0a7cff; color:white; font-weight:600;
    box-shadow: 0 2px 8px rgba(10,124,255,.25); cursor:pointer;
  }
  button.secondary { background:#eef0f4; color:#222; box-shadow:none; }
  main { padding: var(--pad); }
  .card {
    background:#fff; border:1px solid #e8ebf2; border-radius: var(--radius); padding: var(--pad);
    box-shadow: 0 6px 24px rgba(0,0,0,.04);
  }
  ul { list-style: none; padding:0; margin:0; }
  li {
    display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #edf0f6;
    border-radius:12px; margin-bottom:10px; touch-action: manipulation;
  }
  li.done { opacity:.65; text-decoration: line-through; }
  .toolbar { display:flex; gap:var(--gap); flex-wrap: wrap; margin-top: var(--gap); }
  .muted { color:#6b7280; font-size: 13px; }
  .badge { background:#eef4ff; color:#0a7cff; font-weight:600; padding: 6px 10px; border-radius:999px; font-size: 12px; }
  .pill { background:#f1f5f9; border-radius:999px; padding: 3px 8px; font-size:12px; }
  .row-inline { display:flex; gap:10px; align-items:center; }
  .grow { flex:1; }
  .footer-note { padding: var(--pad); color:#6b7280; font-size:12px; text-align:center; }
  @media (prefers-color-scheme: dark) {
    body{ background:#0b0c0e; color:#e5e7eb; }
    header, .card { background:#111318; border-color:#23262d; }
    select, input[type="text"], textarea { background:#0b0c0e; color:#e5e7eb; border-color:#23262d; }
    button.secondary { background:#1b1f26; color:#e5e7eb; }
    li { border-color:#23262d; }
  }
</style>
</head>
<body>
  <header>
    <h1>Rutas de Clientes <span class="badge">offline</span></h1>

    <div class="row">
      <label class="pill" for="rutaSelect">Vista</label>
      <select id="rutaSelect" aria-label="Selecciona una vista/ruta">
        <option value="Lunes">Lunes</option>
        <option value="Martes">Martes</option>
        <option value="Miércoles">Miércoles</option>
        <option value="Jueves">Jueves</option>
        <option value="Viernes">Viernes</option>
        <option value="Festivo">Festivo</option>
        <option value="__ALL__">Todos (catálogo)</option>
      </select>

      <input id="searchBox" type="text" placeholder="Buscar cliente..." aria-label="Buscar cliente" />

      <div id="toolbarRutas" class="toolbar">
        <button id="btnEditar" class="secondary">Editar ruta</button>
        <button id="btnResetRuta" class="secondary">Reiniciar visitas de esta ruta</button>
        <button id="btnResetTodas" class="secondary">Reiniciar TODAS las visitas</button>
      </div>

      <!-- Barra para 'Todos (catálogo)' -->
      <div id="toolbarTodos" class="toolbar" style="display:none;">
        <div class="row-inline grow">
          <span class="pill">Añadir a:</span>
          <select id="targetRoute" class="grow" aria-label="Ruta destino para añadir">
            <option value="Lunes">Lunes</option>
            <option value="Martes">Martes</option>
            <option value="Miércoles">Miércoles</option>
            <option value="Jueves">Jueves</option>
            <option value="Viernes">Viernes</option>
            <option value="Festivo">Festivo</option>
          </select>
        </div>
        <button id="btnAddAllFiltered" class="secondary">Añadir todos (filtrados)</button>
        <button id="btnRemoveAllFiltered" class="secondary">Quitar todos (filtrados)</button>
      </div>

      <!-- Importar catálogo desde PDF o TXT -->
      <div class="toolbar">
        <input id="fileInput" type="file" accept=".pdf,.txt" />
        <button id="btnImportPDF" class="secondary">Importar catálogo (PDF)</button>
        <button id="btnExportCat" class="secondary">Exportar catálogo (TXT)</button>
        <span id="catCount" class="muted">Catálogo: 0</span>
      </div>
    </div>
  </header>

  <main>
    <section id="lista" class="card">
      <h2 style="margin:0 0 10px;"><span id="vistaTitulo">Lunes</span></h2>
      <ul id="clientesUl" aria-live="polite"></ul>
      <p id="vacioMsg" class="muted" style="display:none;">No hay clientes para mostrar.</p>
    </section>

    <!-- Editor simple de la ruta actual -->
    <section id="editor" class="card" aria-hidden="true" style="display:none;">
      <h3 style="margin:0 0 10px;">Editar <span id="rutaEditTitulo">Lunes</span></h3>
      <div class="row-inline">
        <input id="nuevoCliente" class="grow" type="text" placeholder="Añadir cliente (opcional)">
        <button id="btnAdd">Añadir</button>
        <button id="btnGuardar" class="secondary">Guardar rutas</button>
      </div>
      <ul id="editorUl" style="margin-top:12px;"></ul>

      <div class="toolbar" style="margin-top:10px;">
        <button id="btnExportRoutes" class="secondary">Exportar rutas (JSON)</button>
        <button id="btnImportRoutes" class="secondary">Importar rutas (pegar JSON)</button>
      </div>
      <textarea id="jsonBox" rows="6" placeholder='Pega aquí el JSON de tus rutas' style="display:none;"></textarea>
    </section>
  </main>

  <div class="footer-note">Tip: añade esta página a Inicio en el iPhone para usarla como app.</div>

<!-- PDF.js (CDN) para leer PDF en el navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
/* ======= Constantes y claves ======= */
const LS_PREFIX = 'rutas_v3_';
const LS_ROUTES_KEY = LS_PREFIX + 'routes';
const LS_PROGRESS_PREFIX = LS_PREFIX + 'progress_';
const LS_CATALOG_KEY = LS_PREFIX + 'catalog'; // lista maestra (desde tu PDF)
const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes","Festivo"];
const VIEW_ALL = "__ALL__";

/* ======= Utilidades ======= */
const $ = s => document.querySelector(s);
function toast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position:'fixed', left:'50%', bottom:'18px', transform:'translateX(-50%)',
    background:'rgba(0,0,0,.85)', color:'white', padding:'10px 14px',
    borderRadius:'999px', fontSize:'14px', zIndex:9999
  });
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; }, 900);
  setTimeout(()=> t.remove(), 1300);
}

/* ======= Estado ======= */
let ROUTES = loadRoutes();               // { Día: [clientes] }
let CURRENT_VIEW = $("#rutaSelect").value;
let PROGRESS = loadProgress(CURRENT_VIEW); // Set de clientes hechos por ruta
let CATALOG = loadCatalog();             // Array de clientes (desde PDF)

/* ======= Persistencia ======= */
function loadRoutes() {
  try {
    const raw = localStorage.getItem(LS_ROUTES_KEY);
    const defaults = DAYS.reduce((acc,d)=> (acc[d]=acc[d]||[], acc), {Lunes:[],Martes:[],Miércoles:[],Jueves:[],Viernes:[],Festivo:[]});
    if (!raw) return defaults;
    const parsed = JSON.parse(raw);
    // Asegurar que existan todas
    DAYS.forEach(d => { if (!Array.isArray(parsed[d])) parsed[d]=[]; });
    return parsed;
  } catch(_) { return {Lunes:[],Martes:[],Miércoles:[],Jueves:[],Viernes:[],Festivo:[]}; }
}
function saveRoutes() {
  localStorage.setItem(LS_ROUTES_KEY, JSON.stringify(ROUTES));
}
function loadProgress(route) {
  if (!DAYS.includes(route)) return new Set();
  try {
    const raw = localStorage.getItem(LS_PROGRESS_PREFIX + route);
    return raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(_) { return new Set(); }
}
function saveProgress(route, set) {
  if (!DAYS.includes(route)) return;
  localStorage.setItem(LS_PROGRESS_PREFIX + route, JSON.stringify(Array.from(set)));
}
function loadCatalog() {
  try {
    const raw = localStorage.getItem(LS_CATALOG_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch(_) { return []; }
}
function saveCatalog(arr) {
  // Normalizar: quitar vacíos, trim, únicos, orden alfabético
  const set = new Set();
  const clean = [];
  arr.forEach(x => {
    const v = (x||'').toString().trim();
    if (!v) return;
    if (!set.has(v)) { set.add(v); clean.push(v); }
  });
  clean.sort((a,b)=> a.localeCompare(b, 'es', {sensitivity:'base'}));
  localStorage.setItem(LS_CATALOG_KEY, JSON.stringify(clean));
  CATALOG = clean;
  updateCatCount();
}

/* ======= Lógica de catálogo ======= */
function updateCatCount(){
  $("#catCount").textContent = `Catálogo: ${CATALOG.length}`;
}
function isInRoute(route, client) {
  return (ROUTES[route]||[]).includes(client);
}
function addToRoute(route, client) {
  if (!ROUTES[route]) ROUTES[route] = [];
  if (!isInRoute(route, client)) {
    ROUTES[route].push(client);
    saveRoutes();
  }
}
function removeFromRoute(route, client) {
  if (!ROUTES[route]) return;
  const idx = ROUTES[route].indexOf(client);
  if (idx >= 0) {
    ROUTES[route].splice(idx,1);
    saveRoutes();
  }
  const p = loadProgress(route);
  if (p.delete(client)) saveProgress(route, p);
}

/* ======= Render ======= */
function render() {
  $("#vistaTitulo").textContent = (CURRENT_VIEW === VIEW_ALL) ? "Todos (catálogo)" : CURRENT_VIEW;
  const isAll = CURRENT_VIEW === VIEW_ALL;
  $("#toolbarRutas").style.display = isAll ? 'none' : 'flex';
  $("#toolbarTodos").style.display = isAll ? 'flex' : 'none';

  const filter = ($("#searchBox").value || "").trim().toLowerCase();
  const ul = $("#clientesUl");
  ul.innerHTML = "";

  if (isAll) {
    const target = $("#targetRoute").value;
    const list = CATALOG.filter(c => c.toLowerCase().includes(filter));
    $("#vacioMsg").style.display = list.length ? 'none' : 'block';
    list.forEach(client => {
      const li = document.createElement('li');

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = isInRoute(target, client);
      cb.setAttribute('aria-label', `Añadir ${client} a ${target}`);
      cb.addEventListener('change', () => {
        if (cb.checked) { addToRoute(target, client); toast(`Añadido a ${target}`); }
        else { removeFromRoute(target, client); toast(`Quitado de ${target}`); }
      });

      const label = document.createElement('label');
      label.textContent = client;
      label.style.flex = '1';
      label.style.cursor = 'pointer';
      label.addEventListener('click', () => {
        const q = encodeURIComponent(client);
        location.href = `https://maps.apple.com/?q=${q}`;
      });

      const chips = document.createElement('div');
      chips.className = 'row-inline';
      DAYS.forEach(d => {
        if (isInRoute(d, client)) {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = d[0]; // inicial (L,M,Mi,J,V,F)
          chips.appendChild(chip);
        }
      });

      li.appendChild(cb);
      li.appendChild(label);
      li.appendChild(chips);
      ul.appendChild(li);
    });
  } else {
    const clients = (ROUTES[CURRENT_VIEW]||[]).filter(c => c.toLowerCase().includes(filter));
    $("#vacioMsg").style.display = clients.length ? 'none' : 'block';

    clients.forEach(client => {
      const li = document.createElement('li');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.checked = PROGRESS.has(client);
      cb.setAttribute('aria-label', `Visita a ${client}`);
      cb.addEventListener('change', () => {
        if (cb.checked) PROGRESS.add(client); else PROGRESS.delete(client);
        saveProgress(CURRENT_VIEW, PROGRESS);
        li.classList.toggle('done', cb.checked);
      });

      const label = document.createElement('label');
      label.textContent = client;
      label.style.flex = '1';
      label.style.cursor = 'pointer';
      label.addEventListener('click', () => {
        const q = encodeURIComponent(client);
        location.href = `https://maps.apple.com/?q=${q}`;
      });

      li.appendChild(cb);
      li.appendChild(label);
      li.classList.toggle('done', cb.checked);
      ul.appendChild(li);
    });
  }
}

/* ======= Eventos UI ======= */
$("#rutaSelect").addEventListener('change', e => {
  CURRENT_VIEW = e.target.value;
  PROGRESS = loadProgress(CURRENT_VIEW);
  closeEditor();
  render();
});
$("#targetRoute").addEventListener('change', () => render());
$("#searchBox").addEventListener('input', () => render());

$("#btnAddAllFiltered").addEventListener('click', () => {
  const target = $("#targetRoute").value;
  const filter = ($("#searchBox").value || "").trim().toLowerCase();
  const list = CATALOG.filter(c => c.toLowerCase().includes(filter));
  let count = 0;
  list.forEach(c => { if (!isInRoute(target,c)) { addToRoute(target,c); count++; } });
  toast(count ? `Añadidos ${count} a ${target}` : 'Nada que añadir');
  render();
});
$("#btnRemoveAllFiltered").addEventListener('click', () => {
  const target = $("#targetRoute").value;
  const filter = ($("#searchBox").value || "").trim().toLowerCase();
  const list = CATALOG.filter(c => c.toLowerCase().includes(filter));
  let count = 0;
  list.forEach(c => { if (isInRoute(target,c)) { removeFromRoute(target,c); count++; } });
  toast(count ? `Quitados ${count} de ${target}` : 'Nada que quitar');
  render();
});

/* Reinicios */
$("#btnResetRuta").addEventListener('click', () => {
  if (!DAYS.includes(CURRENT_VIEW)) return;
  const ok = confirm(`¿Reiniciar visitas marcadas de "${CURRENT_VIEW}"?`);
  if (!ok) return;
  PROGRESS = new Set();
  saveProgress(CURRENT_VIEW, PROGRESS);
  render();
  toast('Ruta reiniciada');
});
$("#btnResetTodas").addEventListener('click', () => {
  const ok = confirm('¿Reiniciar TODAS las visitas marcadas (todas las rutas)?');
  if (!ok) return;
  DAYS.forEach(d => localStorage.removeItem(LS_PROGRESS_PREFIX + d));
  PROGRESS = loadProgress(CURRENT_VIEW);
  render();
  toast('Todas las visitas reiniciadas');
});

/* ======= Editor de la ruta actual ======= */
const editor = $("#editor");
function openEditor() {
  if (!DAYS.includes(CURRENT_VIEW)) { toast('Elige una ruta (no "Todos")'); return; }
  $("#rutaEditTitulo").textContent = CURRENT_VIEW;
  const ul = $("#editorUl");
  ul.innerHTML = '';
  (ROUTES[CURRENT_VIEW]||[]).forEach((name, idx) => {
    const li = document.createElement('li');
    const span = document.createElement('span'); span.textContent = name; span.style.flex='1';
    const del = document.createElement('button'); del.textContent='Eliminar'; del.className='secondary';
    del.addEventListener('click', () => {
      removeFromRoute(CURRENT_VIEW, name);
      openEditor(); render();
    });
    li.appendChild(span); li.appendChild(del);
    ul.appendChild(li);
  });
  editor.style.display='block'; editor.setAttribute('aria-hidden','false');
  $("#btnEditar").textContent = 'Cerrar editor';
}
function closeEditor() {
  editor.style.display='none'; editor.setAttribute('aria-hidden','true');
  $("#btnEditar").textContent = 'Editar ruta';
}
$("#btnEditar").addEventListener('click', () => {
  const open = editor.style.display === 'block';
  open ? closeEditor() : openEditor();
});
$("#btnAdd").addEventListener('click', () => {
  if (!DAYS.includes(CURRENT_VIEW)) { toast('Elige una ruta'); return; }
  const name = ($("#nuevoCliente").value||'').trim();
  if (!name) { toast('Escribe un nombre'); return; }
  addToRoute(CURRENT_VIEW, name);
  $("#nuevoCliente").value='';
  openEditor(); render(); toast('Cliente añadido');
});
$("#btnGuardar").addEventListener('click', () => { saveRoutes(); toast('Rutas guardadas'); });

/* Exportar/Importar rutas (JSON) */
$("#btnExportRoutes").addEventListener('click', () => {
  const box = $("#jsonBox");
  box.style.display='block';
  box.value = JSON.stringify(ROUTES, null, 2);
  box.focus(); box.select();
  toast('JSON listo para copiar');
});
$("#btnImportRoutes").addEventListener('click', () => {
  const box = $("#jsonBox");
  const visible = box.style.display === 'block';
  if (!visible) { box.style.display='block'; box.value=''; box.placeholder='Pega tu JSON y pulsa de nuevo'; return; }
  try {
    const parsed = JSON.parse(box.value);
    DAYS.forEach(k => { if (!Array.isArray(parsed[k])) parsed[k]=[]; });
    ROUTES = parsed;
    saveRoutes();
    PROGRESS = loadProgress(CURRENT_VIEW);
    render();
    openEditor();
    toast('Rutas importadas');
  } catch(e) {
    alert('JSON inválido');
  }
});

/* ======= Importar catálogo (PDF o TXT) ======= */
$("#btnImportPDF").addEventListener('click', async () => {
  const file = $("#fileInput").files[0];
  if (!file) { alert('Selecciona el archivo PDF o TXT'); return; }

  if (file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt')) {
    // TXT: un cliente por línea
    const text = await file.text();
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    saveCatalog(lines);
    render();
    toast('Catálogo importado (TXT)');
    return;
  }

  if (!(file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))) {
    alert('Elige un PDF o un TXT'); return;
  }

  try {
    const buf = await file.arrayBuffer();
    // PDF.js
    const loadingTask = pdfjsLib.getDocument({ data: buf });
    const pdf = await loadingTask.promise;
    const out = [];
    for (let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      // Extraemos textos en orden aproximado
      content.items.forEach(it => {
        const t = (it.str||'').trim();
        if (t) out.push(t);
      });
    }
    // Heurística: el PDF es una columna/tabla con "Nombre del cliente" como cabecera, 1 nombre por línea.
    // Juntamos tokens por líneas aproximadas: asumimos cada token ya es una línea completa en este PDF.
    // Si vieras clientes pegados, podríamos agrupar por it.transform[5] (Y) o usar saltos detectados.
    const rawLines = out
      .map(s => s.replace(/\s+/g,' ').trim())
      .filter(s => s && !/^nombre del cliente$/i.test(s));
    saveCatalog(rawLines);
    render();
    toast('Catálogo importado (PDF)');
  } catch(e) {
    console.error(e);
    alert('No he podido leer el PDF. Si te falla, exporta el listado a TXT y vuelve a intentar.');
  }
});

/* Exportar catálogo (TXT) */
$("#btnExportCat").addEventListener('click', () => {
  if (!CATALOG.length) { alert('No hay catálogo cargado'); return; }
  const blob = new Blob([CATALOG.join('\n')], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'catalogo_clientes.txt';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ======= Inicio ======= */
(function init(){
  // Asegura claves obligatorias y pinta
  DAYS.forEach(d => { if (!Array.isArray(ROUTES[d])) ROUTES[d]=[]; });
  saveRoutes(); // normaliza estructura
  updateCatCount();
  render();
})();
</script>
</body>
</html>
