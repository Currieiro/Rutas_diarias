<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gestor de Rutas — Activa del día</title>
  <style>
    :root{
      --bg:#5C4033; /* marrón */
      --accent:#FFA500; /* naranja */
      --text:#fff; /* blanco */
      --muted:#cfcfcf;
      --line:#3f2e26;
      --danger:#ff5a5a;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:840px;margin:0 auto;padding:10px 12px 80px}
    h1{font-size:1.15rem;margin:8px 0 12px;text-align:center}

    /* tarjetas */
    .card{border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:10px 0;background:rgba(255,255,255,0.03);backdrop-filter:saturate(120%) blur(0.5px)}
    .card h2{font-size:1rem;margin:0 0 8px;display:flex;align-items:center;gap:.5rem}
    .tag{font-size:.75rem;padding:2px 8px;border-radius:999px;background:var(--accent);color:#000;font-weight:700}

    /* selects / inputs */
    select, input[type="text"]{width:100%;box-sizing:border-box;background:transparent;color:var(--text);border:1px solid var(--accent);border-radius:10px;padding:10px 12px;font-size:1rem}
    select:focus,input:focus{outline:2px solid var(--accent)}

    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .row .shrink{flex:0}

    .btn{appearance:none;border:none;background:var(--accent);color:#000;font-weight:700;border-radius:999px;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    .btn.danger{background:var(--danger);color:#000}

    /* listas */
    .list{list-style:none;margin:8px 0 0;padding:0}
    .item{position:relative;display:flex;gap:10px;align-items:center;border-bottom:1px dashed var(--line);padding:12px 2px}
    .item:last-child{border-bottom:none}
    .visited .name{text-decoration:line-through;color:var(--muted)}
    .check{transform:scale(1.2)}
    .name{flex:1;word-break:break-word}
    .handle{touch-action:none;user-select:none}
    .handle::after{content:"≡";font-size:20px;opacity:.9}

    /* modo edición: aparece el botón eliminar elegante */
    .item .del{display:none}
    .edit-mode .item .del{display:inline-flex}
    .del{align-items:center;justify-content:center;width:28px;height:28px;border-radius:999px;background:transparent;border:1px solid var(--danger);color:var(--danger)}

    /* barra inferior para añadir seleccionados */
    .bar{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);border-top:1px solid var(--line);padding:10px 12px;display:none}
    .bar.show{display:block}
    .bar .btn{width:100%}

    /* chips */
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{font-size:.75rem;border:1px solid var(--accent);color:var(--accent);padding:4px 8px;border-radius:999px}

    /* arrastrando */
    .dragging{z-index:2;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .placeholder{height:52px;border:2px dashed var(--accent);border-radius:10px;margin:6px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gestor de Rutas <span class="version">v 2.4</span> · <span class="tag">Activa del día</span></h1>

    <!-- RUTA ACTIVA DEL DÍA -->
    <section class="card" id="card-active">
      <h2>Ruta activa del día</h2>
      <div class="row" style="margin-bottom:8px">
        <select id="active-select" aria-label="Elegir ruta activa del día"></select>
        <button id="btn-set-active" class="btn shrink" title="Establecer como activa">Fijar</button>
        <button id="btn-edit" class="btn ghost shrink" title="Alternar edición">Editar</button>
      </div>

      <ul id="active-list" class="list"></ul>

      <div class="row" style="margin-top:10px">
        <input id="manual-add" type="text" list="all-clients" placeholder="Añadir cliente manualmente o desde sugerencias…" />
        <button id="btn-manual-add" class="btn shrink">Añadir</button>
      </div>
      <datalist id="all-clients"></datalist>

      <div class="chips" id="hints"></div>

      <div class="row" style="margin-top:10px">
        <button id="btn-reset" class="btn danger">Resetear día</button>
      </div>
    </section>

    <!-- EXPLORAR OTRAS RUTAS -->
    <section class="card">
      <h2>Explorar otras rutas</h2>
      <div class="row" style="margin-bottom:8px">
        <select id="browse-select" aria-label="Explorar rutas"></select>
        <button id="btn-add-selected" class="btn shrink" title="Añadir seleccionados a la activa" disabled>+ a Activa</button>
      </div>
      <ul id="browse-list" class="list"></ul>
    </section>
  </div>

  <div class="bar" id="add-bar">
    <button id="btn-add-bar" class="btn">Añadir 0 seleccionados a la activa</button>
  </div>

  <script>
  // ======= DATOS BASE =======
  const baseRoutes = {
  "Ruta 1": [
    "EL PEDREGAL", "MANDUCA NUEVO", "BAR BUC", "TOC HOSTAL GRAN VIA", 
    "BAR RESTAURANTE LA POMA" , "TIENDA RONDA SANT ANTONI", "BAR CAFETERIA MARIANA",
    "OMBU,RTE", "O CANTO RESTAURANTE", "ROCHA", "MOLI PAN Y CAFE ZONA FRANCA", "MARIMBA",
    "PESSEBRE", "RTE L'ESTONETA", "CUATRECASAS", "PLEASE PLATS"
  ],
  "Ruta 2": [
    "CAN BUIGAS", "TRES TORRES", "PETIT RACÓ", "SAN GERVASI", "DURO", "SANT FRANCESC", "MONREAL", 
    "CAL PEP", "SINGLOT", "LA ROVIRA", "FLANDERS", "CIURI´S", "BRASAS", "KOKCHA", 
    "ESTRELLA GALICIA", "HANAIKADA SUSHI", "LURI", "MEET THAI", "DA ANTONIO", "CLUB DE TIRO",
    "CAFE ILUSIONA BY MUXIA", "RIAS DE GALICIA RTE", "CASA DE TAPAS LA CAÑOTA"
  ],
  "Ruta 3": [
    "TIENDA LES CORTS", "MANDONI PEDRALBES", "EL MOLI PAN Y CAFE SANTS",
    "FORN VELL INDUSTRIA", "SICILIA", "FORN VELL CLARET", "ARTESANO", "BOEDO", "AMAZONAS", "BERGUEDÀ"
  ],
  "Ruta 4": [
    "EL PEDREGAL", "ORDAL", "CAFETERÍA PIPA'S", "TIENDA CLOT", "LA RUTA GALLEGA", "BAR CAÑAS", "RINCÓN GALLEGO MERIDIANA", "TIENDA MERIDIANA II",
    "RINCON GALEGO", "TIENDA JOAQUIM VALLS", "FRANKFURT TOLIK", "FURACU", "MI RINCÓN", "CASA ANGEL", "BAR EUROPA", "EL MIRALL DELS ENCANTS"
  ],
  "Ruta 5": [
    "TIENDA TORRAS I BAGES", "TIENDA VIA JULIA", "VALLDAURA", "TIENDA TALLER VALLDAURA", "AMPARITO",
    "BAR LOS PINOS 2", "SET POINT", "LA CASSOLETA", "LES CATIVAS"
  ],
  "Clientes que llaman": [
    "RTE PIPA", "YA MEI", "O BURATO BAR", "A PROP TEU", "DAMAIA", "ANTOTXO", "TEATRO NACIONAL DE CATALUNYA", 
    "TASQUETA DE BLAI", "ESTACIÓN DE SERVICIO PARALELO", "SMASH HIRO", "EVENTOS MUXIA", "BESTA", "TIO BIGOTES", 
    "HOTEL ZENIT", "BAR 70/30", "ALTIMA RONDA DE DALT", "HELADERÍA ADRI", 
    "GULA SANA", "PIERRE VACANCES OFICINAS", "PIERRE VACANCES SANTS", "ZAMORA", "RESTAURANT CENT FOCS",
    "HOTEL MESON CASTILLA", "BAR RTE LEPANTO", "EXE RAMBLAS BOQUERIA", "RESTAURANTE HONKAKU II",
    "SARA TAPES", "HOTEL SB GLOW", "HOTEL SB ICARIA BARCELONA", "CAFETERIA DOMI",
    "LA FILOMENA BAR", "EUROSTARS ANGLI", "ATICCO PASSEIG DE GRÀCIA CANTINA",
    "EXE LAIETANA PALACE", "EUROSTARS CRISTAL PALACE", "MIRADOR SANT JUST", "IKONIK RAMBLAS",
    "ALTIMA HOSPITALET GRAN VIA", "EXE PLAZA CATALUNYA", "EUROSTARS MONUMENTAL",
    "EUROSTARS MITRE", "RESTAURANTE LA GORMANDA", "TOSTA BAR", "ADELITA RESTAURANTE",
    "LOKAL", "BATEA", "TSUKIMI", "LA PALMERA", "LOMO ALTO", "HOTEL ORIENTE", "HOTEL ARENAS",
    "HOTEL TRES TORRES", "ESCAIRON", "LA BRASA RESTAURANTE", "RTE ANCARES", "HOTEL SB WIN SANT FELIU",
    "RTE MAMETORA", "R.U. COSMOPOLITAN", "ESCUELA JUDICIAL BCN", "O MEU LAR", "GREENVITA NUMANCIA",
    "EL RACONET D'URGELL", "CHALITO BCN.", "CLUB TIRO MONTJUIT", "FRANKFURT SANTS",
    "R.U. EMILIE DE VILLENUEVE", "SOLUCIONS SOCIALS INSERCIO", "ALTIMA SANT BOI",
    "FUNDACIO ASPACE CATALUNYA", "GREEN VITA GLORIES", "ATICCO PASSEIG DE GRÀCIA OFICINA", "SANED THAU"
  ]
};
  const routeNames = ["Ruta 1","Ruta 2","Ruta 3","Ruta 4","Ruta 5","Clientes que llaman"];
  const keyFor = (route) => route.toLowerCase().split(' ').join('_').replaceAll('ñ','n');

  // ======= ESTADO Y PERSISTENCIA =======
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>[...root.querySelectorAll(s)];
  const activeSelect = $('#active-select');
  const browseSelect = $('#browse-select');
  const activeListEl = $('#active-list');
  const browseListEl = $('#browse-list');
  const btnSetActive = $('#btn-set-active');
  const btnEdit = $('#btn-edit');
  const btnReset = $('#btn-reset');
  const inputManual = $('#manual-add');
  const btnManualAdd = $('#btn-manual-add');
  const allClientsDL = $('#all-clients');
  const hints = $('#hints');
  const addBar = $('#add-bar');
  const btnAddSelected = $('#btn-add-selected');
  const btnAddBar = $('#btn-add-bar');

  let currentActiveRoute = localStorage.getItem('activeRouteName') || 'Ruta 1';
  let routeStates = {}; // { routeName: [{name,visited}], ... }

  // cargar estados guardados (si los hay)
  for (const r of routeNames){
    const saved = localStorage.getItem('state_'+keyFor(r));
    if (saved){ try{ routeStates[r] = JSON.parse(saved); }catch{ /* ignore */ } }
  }

  // helpers de persistencia
  function saveRouteState(route){
    localStorage.setItem('state_'+keyFor(route), JSON.stringify(routeStates[route]||[]));
  }
  function setActiveRouteName(name){
    currentActiveRoute = name;
    localStorage.setItem('activeRouteName', name);
  }

  // ======= INICIALIZACIÓN DE SELECTS Y DATALIST =======
  function fillSelect(sel){
    sel.innerHTML = '';
    for (const r of routeNames){
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r; sel.appendChild(opt);
    }
  }
  fillSelect(activeSelect); fillSelect(browseSelect);
  activeSelect.value = currentActiveRoute;
  browseSelect.value = routeNames[0];

  // datalist de todos los clientes para autocompletar
  (function populateDatalist(){
    const set = new Set();
    routeNames.forEach(r=> baseRoutes[r].forEach(n=> set.add(n)));
    allClientsDL.innerHTML = '';
    for (const n of set){
      const o = document.createElement('option'); o.value = n; allClientsDL.appendChild(o);
    }
  })();

  // chips de atajo (los 5 últimos añadidos)
  function refreshHints(){
    const hist = JSON.parse(localStorage.getItem('recentAdds')||'[]');
    hints.innerHTML = '';
    hist.forEach(n=>{
      const c = document.createElement('button');
      c.className = 'chip'; c.textContent = '+ '+n;
      c.addEventListener('click', ()=>{ addToActive([n]); });
      hints.appendChild(c);
    });
  }
  refreshHints();

  function pushRecent(name){
    const hist = JSON.parse(localStorage.getItem('recentAdds')||'[]');
    const arr = [name, ...hist.filter(x=>x!==name)].slice(0,5);
    localStorage.setItem('recentAdds', JSON.stringify(arr));
    refreshHints();
  }
  function removeFromRecent(name){
    const hist = JSON.parse(localStorage.getItem('recentAdds')||'[]');
    const arr = hist.filter(x=>x!==name);
    localStorage.setItem('recentAdds', JSON.stringify(arr));
    refreshHints();
  }

  // ======= CARGA DE LISTAS =======
  function ensureState(route){
    if (!routeStates[route]){
      routeStates[route] = baseRoutes[route].map(n=>({name:n, visited:false}));
    }
  }

  function renderActive(){
    ensureState(currentActiveRoute);
    const list = routeStates[currentActiveRoute];
    activeListEl.innerHTML = '';
    list.forEach((item, idx)=>{
      const li = document.createElement('li'); li.className='item'; li.dataset.index = idx;
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='check'; cb.checked=!!item.visited;
      cb.addEventListener('change', ()=>{ item.visited = cb.checked; saveRouteState(currentActiveRoute); li.classList.toggle('visited', item.visited); });
      const name = document.createElement('div'); name.className='name'; name.textContent=item.name;

      const handle = document.createElement('button'); handle.className='handle btn ghost shrink'; handle.title='Arrastrar para reordenar'; handle.textContent='';
      makeDraggable(li, handle, list);

      const del = document.createElement('button'); del.className='del'; del.title='Eliminar'; del.textContent='–';
      del.addEventListener('click', ()=>{
        const nameToRemove = item.name;
        list.splice(idx,1);
        saveRouteState(currentActiveRoute);
        renderActive();
        removeFromRecent(nameToRemove);
      });

      if (item.visited) li.classList.add('visited');
      li.append(cb, name, handle, del);
      activeListEl.appendChild(li);
    });
    activeListEl.parentElement.classList.toggle('edit-mode', editMode);
  }

  function renderBrowse(){
    const r = browseSelect.value;
    const names = baseRoutes[r];
    browseListEl.innerHTML = '';
    names.forEach((n)=>{
      const li = document.createElement('li'); li.className='item';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='check'; cb.dataset.name = n;
      cb.addEventListener('change', updateSelectionBar);
      const name = document.createElement('div'); name.className='name'; name.textContent = n;
      li.append(cb, name);
      browseListEl.appendChild(li);
    });
    updateSelectionBar();
  }

  // ======= REORDENAR ELEGANTE (arrastrar con "handle") =======
  let editMode = false;
  btnEdit.addEventListener('click', ()=>{
    editMode = !editMode;
    btnEdit.textContent = editMode ? 'Listo' : 'Editar';
    activeListEl.parentElement.classList.toggle('edit-mode', editMode);
  });

  function makeDraggable(li, handle, list){
    let dragging = false, startY=0, startTop=0, startIdx=0, itemHeight=0, placeholder=null;

    function onPointerDown(e){
      e.preventDefault();
      dragging = true;
      startY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      const rect = li.getBoundingClientRect();
      startTop = li.offsetTop; startIdx = +li.dataset.index; itemHeight = rect.height;
      li.classList.add('dragging');
      li.style.position='absolute';
      li.style.left='0'; li.style.right='0'; li.style.width='100%';
      li.style.top = startTop + 'px';
      li.style.pointerEvents='none';
      // placeholder
      placeholder = document.createElement('div'); placeholder.className='placeholder';
      activeListEl.insertBefore(placeholder, li.nextSibling);
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp, {once:true});
      window.addEventListener('touchmove', onPointerMove, {passive:false});
      window.addEventListener('touchend', onPointerUp, {once:true});
    }

    function onPointerMove(e){
      if (!dragging) return;
      const y = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      const dy = y - startY;
      li.style.top = (startTop + dy) + 'px';
      e.preventDefault();
      // calcular posición objetivo
      const currentTop = startTop + dy;
      let toIndex = Math.round(currentTop / itemHeight);
      toIndex = Math.max(0, Math.min(toIndex, activeListEl.children.length-1));
      const ref = activeListEl.children[toIndex];
      if (ref && ref !== placeholder){
        activeListEl.insertBefore(placeholder, (currentTop < placeholder.offsetTop) ? ref : ref.nextSibling);
      }
    }

    function onPointerUp(){
      if (!dragging) return; dragging=false;
      // calcular índice final a partir del placeholder
      const children = [...activeListEl.children];
      const newIdx = Math.max(0, children.indexOf(placeholder));
      placeholder.remove();
      li.classList.remove('dragging');
      li.style.cssText='';

      if (newIdx !== startIdx){
        const [moved] = list.splice(startIdx,1);
        list.splice(newIdx,0,moved);
        saveRouteState(currentActiveRoute);
        renderActive();
      } else {
        // re-pintar índices
        $$('.item', activeListEl).forEach((el,i)=> el.dataset.index=i);
      }
      window.removeEventListener('pointermove', onPointerMove);
      window.removeEventListener('touchmove', onPointerMove);
    }

    handle.addEventListener('pointerdown', onPointerDown);
    handle.addEventListener('touchstart', onPointerDown, {passive:false});
  }

  // ======= OPERACIONES =======
  function addToActive(names){
    ensureState(currentActiveRoute);
    const list = routeStates[currentActiveRoute];
    const existing = new Set(list.map(x=>x.name));
    let added = 0;
    names.forEach(n=>{
      if (!existing.has(n)){
        list.push({name:n, visited:false});
        existing.add(n); added++; pushRecent(n);
      }
    });
    if (added>0){ saveRouteState(currentActiveRoute); renderActive(); }
  }

  function updateSelectionBar(){
    const selected = $$('input.check:checked', browseListEl).map(cb=>cb.dataset.name);
    btnAddSelected.disabled = selected.length===0;
    btnAddSelected.textContent = `+ (${selected.length})`;
    btnAddBar.textContent = `Añadir ${selected.length} seleccionados a la activa`;
    addBar.classList.toggle('show', selected.length>0);
  }

  // ======= EVENTOS UI =======
  btnSetActive.addEventListener('click', ()=>{
    setActiveRouteName(activeSelect.value);
    renderActive();
  });

  browseSelect.addEventListener('change', renderBrowse);

  btnAddSelected.addEventListener('click', ()=>{
    const names = $$('input.check:checked', browseListEl).map(cb=>cb.dataset.name);
    addToActive(names);
    $$('input.check:checked', browseListEl).forEach(cb=> cb.checked=false);
    updateSelectionBar();
  });
  btnAddBar.addEventListener('click', ()=>{ btnAddSelected.click(); });

  btnManualAdd.addEventListener('click', ()=>{
    const n = (inputManual.value||'').trim();
    if (!n) return;
    addToActive([n]);
    inputManual.value='';
  });
  inputManual.addEventListener('keydown', e=>{ if (e.key==='Enter') btnManualAdd.click(); });

  btnReset.addEventListener('click', ()=>{
    if (!confirm('Esto restaurará la lista de la ruta activa a su estado original y limpiará los checks. ¿Seguro?')) return;
    routeStates[currentActiveRoute] = baseRoutes[currentActiveRoute].map(n=>({name:n, visited:false}));
    saveRouteState(currentActiveRoute);
    renderActive();
  });

  // ======= INICIO =======
  renderActive();
  renderBrowse();
  </script>
</body>
</html>
